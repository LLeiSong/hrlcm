---
title: "Manuscript figures"
author: "Lei Song"
date: "6/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

## Introduction

This is just a markdown to record the script to generate figures for the paper.

## Study area

Study area figure should include a overall view of study area in a bigger background, a zoom-in view of the study area (northern of Tanzania), the ecozones, the NICFI tiling system and the following sub-tiling system, 

```{r}
library(here)
library(sf)
library(nngeo)
library(ggplot2)
library(ggspatial)
library(RColorBrewer)
library(dplyr)
library(rnaturalearth)

# Read boundaries
tz_bry <- read_sf(here('data/geoms/tanzania.geojson'))
study_area <- read_sf(here('data/geoms/study_area.geojson')) %>% 
    st_remove_holes()
nicfi_tiles <- read_sf(here('data/geoms/tiles_nicfi_north.geojson')) %>% 
    mutate(`NICFI tile` = 1)
ecozones <- read_sf(here('data/geoms/ecozones.geojson')) %>% 
    st_intersection(study_area) %>% 
    rename(Ecozone = zone)

# The overview of study area in the whole country at the left corner
# Get the surrounding countries
countries <- ne_countries(type = 'countries', scale = 'large',
                          returnclass = 'sf') %>% 
    st_intersection(., st_bbox(tz_bry) %>% 
                        st_as_sfc() %>% 
                        st_buffer(5, joinStyle = 'MITRE') %>% 
                        st_bbox(tz_bry) %>% # Get he squared one
                        st_as_sfc())

# Make overview
xlim <- c(st_bbox(countries)[1] + 3, st_bbox(countries)[3] - 3)
ylim <- c(st_bbox(countries)[2] + 3, st_bbox(countries)[4] - 3)
overview <- ggplotGrob(ggplot(tz_bry) +
    geom_sf(fill = 'lightblue', color = 'grey') +
    geom_sf_text(aes(label = geounit), size = 4) +
    geom_sf(data = countries, fill = NA, color = 'grey') +
    geom_sf(data = study_area, fill = 'red', color = 'grey') +
    coord_sf(xlim = xlim, ylim = ylim) +
    theme_bw() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          plot.margin = unit(rep(0, 4), "cm")))

# Make the main figure
main_fg <- ggplot(ecozones) +
    geom_sf(aes(fill = Ecozone), 
            color = 'grey') +
    scale_fill_brewer(palette = 'Accent') +
    geom_sf(data = nicfi_tiles, fill = NA, 
            aes(color = "black", lty = "dotted"), 
            lwd = 0.4) +
    geom_sf(data = study_area, fill = NA, 
            aes(color = 'red', lty = 'solid')) +
    scale_color_identity(name = '',
                         breaks = c('black', 'red'),
                         labels = c('NICFI tiles', 'Study area'),
                         guide = 'legend') +
    scale_linetype_identity(name = '',
                            breaks = c('dotted', 'solid'),
                            labels = c('NICFI tiles', 'Study area'),
                            guide = 'legend') +
    annotation_custom(grob = overview, 
                      xmin = 36.5, xmax = 38.5,
                      ymin = -2.3, ymax = -0.5) +
    annotation_scale(location = 'br', text_cex = 1) +
    annotation_north_arrow(which_north = "true", location = 'tl') +
    theme_minimal() + 
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          legend.text = element_text(size = 12),
          plot.margin = unit(rep(0, 4),"cm"))

ggsave(here('docs/figures/study_area.png'),
       main_fg,
       width = 10, height = 5.7, dpi = 600)
main_fg
```

## Satellite images

This figure will provide an example of satellite images including NICFI images with two seasons, and the harmonic regression of Sentinel-1 images.

```{r}
library(sf)
library(raster)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tidyr)
library(stringr)
library(RStoolbox)

# Read example images
# tile 1227-1002, 
# this tile has a few different land cover types and obvious characteristics
# so it could be a good example tile.
tile_id <- '1227-1002'
fnames_nicfi <- list.files(here('data/plts_nicfi'),
                           pattern = tile_id,
                           full.names = T)
nicfi_s1 <- stack(fnames_nicfi[1]) %>% subset(1:4)
nicfi_s2 <- stack(fnames_nicfi[2]) %>% subset(1:4)
rm(fnames_nicfi)

# Define example points
pts_example <- read_sf(here('data/north/pts_example.shp')) %>% 
    st_cast('POINT')

# NICFI
# Transform points
pts_nicfi <- pts_example %>% 
    st_transform(crs = crs(nicfi_s1))

# Define colors
cols_lc <- tibble(cols = c('#ff7f00', '#074702', '#b2df8a',
                           '#33a02c', '#3347f9', '#5a6057',
                           '#fdbf6f'),
                  `Land cover type` = c("Cropland", 'Forest', "Grassland", 
                                        'Shrubland',  "Water", "Built-up",
                                        'Bareland'),
                  ids = as.factor(1:7))

# Image of season 1
s1_fg <- ggRGB(nicfi_s1, r = 4, g = 3, b = 2, 
               scale = max(values(nicfi_s1)[, 2:4]), 
               stretch = 'hist') +
    geom_sf(data = pts_nicfi,
            color = 'black',
            size = 3) +
    geom_sf(data = pts_nicfi,
            aes(color = factor(id)),
            size = 2,
            show.legend = F) +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    theme_minimal() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          plot.margin = unit(rep(0, 4),"cm"))

# Image of season 2
s2_fg <- ggRGB(nicfi_s2, r = 4, g = 3, b = 2, 
               scale = max(values(nicfi_s2)[, 2:4]), 
               stretch = 'lin') +
    geom_sf(data = pts_nicfi,
            color = 'black',
            size = 3) +
    geom_sf(data = pts_nicfi,
            aes(color = factor(id)),
            size = 2,
            show.legend = F) +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    theme_minimal() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          plot.margin = unit(rep(0, 4),"cm"))

# Spectral signature of examples
# Extract values
pts_nicfi_s1 <- raster::extract(nicfi_s1, pts_nicfi) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_nicfi$type) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(`Band name` = c('Blue', 'Green', 'Red', 'NIR'),
           Band = 1:4) %>% 
    pivot_longer(cols = names(.)[1:(ncol(.) - 2)], 
                 names_to = 'Land cover type',
                 values_to = 'Reflectance') %>% 
    mutate(`Land cover type` = as.factor(`Land cover type`),
           Season = 'Season 1')
pts_nicfi_s2 <- raster::extract(nicfi_s2, pts_nicfi) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_nicfi$type) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(`Band name` = c('Blue', 'Green', 'Red', 'NIR'),
           Band = 1:4) %>% 
    pivot_longer(cols = names(.)[1:(ncol(.) - 2)], 
                 names_to = 'Land cover type',
                 values_to = 'Reflectance') %>% 
    mutate(`Land cover type` = as.factor(`Land cover type`),
           Season = 'Season 2')
pts_nicfi_all <- rbind(pts_nicfi_s1, pts_nicfi_s2)
rm(pts_nicfi_s1, pts_nicfi_s2)

# Figure
pts_nicfi_all <- merge(pts_nicfi_all, cols_lc[, 2:3])
ref_epl <- ggplot(pts_nicfi_all,
                  aes(x = Band, y = Reflectance / 1000,
                      color = ids)) +
    geom_point() + geom_line(show.legend = 'line') +
    ylab(bquote('Reflectance'~(10^3))) + 
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    scale_x_discrete(limit = factor(1:4),
                     labels = unique(pts_nicfi_all$`Band name`)) +
    theme_bw() +
    theme(axis.title.x = element_blank()) +
    facet_wrap(~ Season, nrow = 2, 
               scales = "free_y",
               strip.position = "top")

nicfi_fg <- ggarrange(
    ggarrange(s1_fg, s2_fg,
              labels = c('Season 1', 'Season 2'),
              font.label = list(size = 12),
              vjust = 3,
              ncol = 2), 
    ref_epl, ncol = 2)
ggsave(here('docs/figures/nicfi_image.png'),
       nicfi_fg,
       width = 8, height = 2.7, dpi = 300)

# Sentinel-1 harmonic coefficient regression
fnames_s1 <- list.files(here('data/s1_harmonic'),
                        pattern = tile_id,
                        full.names = T)
vv_coefs <- stack(fnames_s1[str_detect(fnames_s1, 'VV')])
vh_coefs <- stack(fnames_s1[str_detect(fnames_s1, 'VH')])

# Image of VV
# Slope, Cos(x), Intercept
vv_fg <- ggRGB(vv_coefs, r = 2, g = 4, b = 1, 
               scale = max(values(vv_coefs)[, c(2, 4, 1)]), 
               stretch = 'hist') +
    geom_sf(data = pts_example,
            color = 'white',
            size = 3) +
    geom_sf(data = pts_example,
            aes(color = factor(id)),
            size = 2,
            show.legend = F) +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    theme_minimal() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          plot.margin = unit(rep(0, 4),"cm"))

# Image of VH
# Slope, Cos(x), Intercept
vh_fg <- ggRGB(vh_coefs, r = 2, g = 4, b = 1, 
               scale = max(values(vh_coefs)[, c(1, 2, 4)]), 
               stretch = 'lin') +
    geom_sf(data = pts_example,
            color = 'white',
            size = 3) +
    geom_sf(data = pts_example,
            aes(color = factor(id)),
            size = 2,
            show.legend = F) +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    theme_minimal() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          plot.margin = unit(rep(0, 4),"cm"))

# Time series and harmonic fitting of examples
# out = cos((2 * pi * n0 * t) / freq - (n % 2) * pi / 2)
# n_0 = {0,1,1,2,2}
# n = {0,1,2,3,4}
# freq = 365
# Band1: intercept
# Band2: slope
# Band3: sin(x)
# Band4: cos(x)
# Band5: sin(2x)
# Band6: cos(2x)

# Real time series
## Images
vv_ts <- stack(
    list.files(here('data/s1_timeseries_example/temp_ard_1227-1002'),
               pattern = 'VV',
               full.names = T)) 
vh_ts <- stack(
    list.files(here('data/s1_timeseries_example/temp_ard_1227-1002'),
               pattern = 'VH',
               full.names = T))

# DOY
doy <- c(0,   9,  12,  21,  33,  45,  48,  57,  69,  81,  93, 105, 117,
       129, 141, 153, 165, 177, 189, 201, 213, 225, 237, 249, 261, 273,
       285, 288, 293, 297, 300, 305, 309, 312, 317, 321, 324, 329, 333,
       336, 345, 348, 357, 360)

# Extract values
pts_vv_ts <- raster::extract(vv_ts, pts_example) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_example$type) %>% 
    mutate(date = rownames(.)) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(date = str_extract(date, '[0-9]{8}')) %>% 
    arrange(date) %>% 
    mutate(DOY = doy, polarization = 'VV',
           type = 'Real value')

pts_vh_ts <- raster::extract(vh_ts, pts_example) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_example$type) %>% 
    mutate(date = rownames(.)) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(date = str_extract(date, '[0-9]{8}')) %>% 
    arrange(date) %>% 
    mutate(DOY = doy, polarization = 'VH',
           type = 'Real value')

pts_ts <- rbind(pts_vv_ts, pts_vh_ts) %>% 
    dplyr::select(-date) %>% 
    pivot_longer(names(.)[1:7], 
                 names_to = "Land cover type", 
                 values_to = "dB")
rm(pts_vv_ts, pts_vh_ts)

# Harmonic coefficients
pts_vv <- raster::extract(vv_coefs, pts_example) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_example$type) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(`Band name` = c('Intersept', 'Slope', 
                           'Sin(x)', 'Cos(x)', 
                           'Sin(2x)', "Cos(2x)"), Band = 1:6)

pts_vv_fit <- do.call(cbind, lapply(names(pts_vv)[1:7], function(typ){
    coefs <- pts_vv %>% pull(typ)
    data.frame(val = coefs[1] + coefs[2] * doy +
    coefs[3] * sin(2 * pi * doy /365) + 
    coefs[4] * cos(2 * pi * doy /365) + 
    coefs[5] * sin(4 * pi * doy /365) + 
    coefs[6] * cos(4 * pi * doy /365))
})) %>% `names<-`(names(pts_vv)[1:7]) %>% 
    mutate(DOY = doy) %>% 
    mutate(polarization = 'VV',
           type = 'Harmoic regression')
    
pts_vh <- raster::extract(vh_coefs, pts_example) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_example$type) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(`Band name` = c('Intersept', 'Slope', 
                           'Sin(x)', 'Cos(x)', 
                           'Sin(2x)', "Cos(2x)"), Band = 1:6)

pts_vh_fit <- do.call(cbind, lapply(names(pts_vh)[1:7], function(typ){
    coefs <- pts_vh %>% pull(typ)
    data.frame(val = coefs[1] + coefs[2] * doy +
    coefs[3] * sin(2 * pi * doy /365) + 
    coefs[4] * cos(2 * pi * doy /365) + 
    coefs[5] * sin(4 * pi * doy /365) + 
    coefs[6] * cos(4 * pi * doy /365))
})) %>% `names<-`(names(pts_vh)[1:7]) %>% 
    mutate(DOY = doy) %>% 
    mutate(polarization = 'VH',
           type = 'Harmoic regression')

pts_fit <- rbind(pts_vv_fit, pts_vh_fit) %>% 
    pivot_longer(names(.)[1:7], 
                 names_to = "Land cover type", 
                 values_to = "dB")
rm(pts_vv_ts, pts_vh_ts)

# Make figure
pts_ts <- merge(pts_ts, cols_lc[, 2:3])
pts_fit <- merge(pts_fit, cols_lc[, 2:3])
ts_epl <- ggplot() + 
    geom_point(data = pts_ts, 
               aes(x = DOY, y = `dB`, 
                   color = factor(ids)),
               size = 0.6) +
    geom_line(data = pts_fit,
               aes(x = DOY, y = `dB`, 
                   color = factor(ids))) +
    facet_wrap(~polarization, 
               scales = 'free_y', nrow = 2,
               strip.position = "top") +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    theme_bw()

s1_fg <- ggarrange(
    ggarrange(vv_fg, vh_fg,
              labels = c('VV', 'VH'),
              font.label = list(size = 12),
              vjust = 3,
              ncol = 2), 
    ts_epl, ncol = 2)

ggsave(here('docs/figures/s1_image.png'),
       s1_fg,
       width = 8, height = 2.7, dpi = 300)
```

## Samples for Random forest and U-Net

This figure will provide the selected 200 tiles for RF to predict, the sub-tiling system for human checking, and the distribution of sub-tiles (chips) with score higher than 7.

```{r}
library(sf)
library(rasterVis)
library(ggnewscale)
library(cowplot)

id_selected <- '1240-995'
# Read tiles
nicfi_tiles <- read_sf(
    here('data/geoms/tiles_nicfi_north.geojson'))

# Sub-tiling
indices <- matrix(1:64, 8, 8)
indices <- indices[, ncol(indices):1]
sub_tiling <- nicfi_tiles %>% 
    filter(tile == id_selected) %>% 
    st_make_grid(n = c(8, 8)) %>% 
    st_sf() %>% 
    mutate(index = as.vector(indices))
trains_inside <- sub_tiling %>% 
    filter(index %in% (read.csv(
    here('results/north/dl_catalog_train.csv'),
    stringsAsFactors = F) %>% 
    filter(tile == id_selected) %>% 
    pull(index))) %>% 
    mutate(Usage = 'Train')
valids_inside <- sub_tiling %>% 
    filter(index %in% (read.csv(
    here('results/north/dl_catalog_valid.csv'),
    stringsAsFactors = F) %>% 
    filter(tile == id_selected) %>% 
    pull(index))) %>% 
    mutate(Usage = 'Validate')
# Labels of each sub-tile
sub_tiles <- rbind(trains_inside, valids_inside) %>% 
    arrange(index); rm(trains_inside, valids_inside)

# Sub-tiling figure
sub_tiling_fg <- ggplot(sub_tiling) + 
    geom_sf(data = sub_tiles, aes(fill = Usage),
            color = 'blue', lwd = 0.3) +
    scale_fill_manual(values = c('forestgreen', 'orangered')) +
    geom_sf(color = 'blue', fill = NA, lwd = 0.3) + 
    geom_sf_text(aes(label = index), size = 2.5) +
    theme_minimal() +
    theme(legend.position = 'bottom',
          axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = -0.15, vjust = -6),
          plot.margin = unit(rep(0, 4),"cm"))

# Weak labels
labels_esb <- lapply(1:nrow(sub_tiles), function(n){
    raster(here('data/north/lc_labels_north_mask.tif')) %>% 
        crop(sub_tiles %>% slice(n))
}); names(labels_esb) <- sub_tiles$index

labels_guess <- lapply(sub_tiles$index, function(id){
    prefix <- glue('results/north/guess_labels/guess_{id_selected}')
    raster(here(glue('{prefix}_{id}.tif')))
}); names(labels_guess) <- sub_tiles$index

labels_refine <- lapply(sub_tiles$index, function(id){
    prefix <- glue('results/north/refine_labels/{id_selected}')
    raster(here(glue('{prefix}_{id}_label.tif')))
}); names(labels_refine) <- sub_tiles$index

# Plot
color_tb <- data.frame(
    id = 1:7,
    type = c("Cropland", "Forest", 
             "Grassland", "Shrubland", 
             "Water", 'Built-up', "Bareland"),
    color = c('#ff7f00', '#074702', '#b2df8a',
              '#33a02c', '#3347f9', '#5a6057',
              '#fdbf6f'))
plot_rst <- function(rst, bry){
    r_df <- as.data.frame(rst, xy = TRUE) %>%
        `colnames<-`(c('x', 'y', 'rst')) %>%
        mutate(rst = as.factor(rst)) %>% 
        na.omit()
    colors <- color_tb %>% filter(id %in% unique(r_df$rst))
    
    # plot
    ggplot() + 
        geom_raster(
            data = r_df, 
            aes(x = x, y = y, 
                fill = rst)) +
        scale_fill_manual(
            values = colors %>% pull(color), 
            breaks = colors %>% pull(id),
            labels = colors %>% pull(type)) +
        geom_sf(data = bry, 
                color = 'blue', fill = NA,
                lty = 'dotted', lwd = 0.4) +
        theme_minimal() +
        theme(legend.position = 'none',
              axis.title.x = element_blank(),
              axis.text.x = element_blank(),
              axis.ticks.x = element_blank(),
              axis.title.y = element_blank(),
              axis.text.y = element_blank(),
              axis.ticks.y = element_blank(),
              panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank(),
              plot.margin = unit(rep(0, 4),"cm"))
}

plots_esb <- lapply(1:length(labels_esb), function(n) {
    nm <- names(labels_guess)[n]
    bry <- sub_tiles %>% filter(index == nm)
    plot_rst(labels_esb[[n]], bry)
})

plots_guess <- lapply(1:length(labels_guess), function(n) {
    nm <- names(labels_guess)[n]
    bry <- sub_tiles %>% filter(index == nm) %>% 
        st_transform(crs = crs(labels_guess[[n]]))
    plot_rst(labels_guess[[n]], bry)
})

plots_refine <- lapply(1:length(labels_refine), function(n) {
    nm <- names(labels_refine)[n]
    bry <- sub_tiles %>% filter(index == nm) %>% 
        st_transform(crs = crs(labels_refine[[n]]))
    plot_rst(labels_refine[[n]], bry)
})

# Ensemble plots
## Legend
r_df <- data.frame(x = 1:7, 
                   y = 1:7,
                   rst = as.factor(1:7))
legend_lc <- ggplot() + 
    geom_raster(
        data = r_df, 
        aes(x = x, y = y, 
            fill = rst)) +
    scale_fill_manual('Land cover',
                      values = c('#ff7f00', '#074702', '#b2df8a',
                                 '#33a02c', '#3347f9', '#5a6057',
                                 '#fdbf6f'), 
                      breaks = 1:7,
                      labels = c("Cropland", 'Forest', "Grassland", 
                                 'Shrubland',  "Water", "Built-up",
                                 'Bareland')) +
    theme_minimal() +
    theme(legend.position = 'right',
          axis.title.x = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(),
          plot.margin = unit(rep(0, 4),"cm"))+
    guides(fill = guide_legend(ncol = 2))

legend_lc <- get_legend(legend_lc)
sub_tiling_fg <- ggarrange(NULL, sub_tiling_fg, legend_lc, NULL,
                           nrow = 4, heights = c(0.3, 2, 1, 0.3))

esb_fg <- ggarrange(plotlist = plots_esb, ncol = 4,
                    labels = sub_tiles$index, 
                    hjust = -2.5)
guess_fg <- ggarrange(plotlist = plots_guess, ncol = 4)
refine_fg <- ggarrange(plotlist = plots_refine, ncol = 4)
fgs <- ggarrange(esb_fg, guess_fg, refine_fg, nrow = 3,
                 labels = c('A', 'B', 'C'),
                 hjust = 0.4, vjust = 6,
                 font.label = list(face = "plain"))
labels_fg <- ggarrange(NULL, fgs, sub_tiling_fg, 
                       ncol = 3, widths = c(0.1, 2, 1))

ggsave(here('docs/figures/labels.png'),
       labels_fg,
       width = 8, height = 4, dpi = 300)
```

## Workflow

This figure will provide an overall flowchart of methods.

## Results
### Learning rate comparison

```{r}
library(tidyverse)
# Define function
get_curves <- function(experiment_name,
                       step = 59,
                       path = here('results/scalar/compare_lr')){
    # Get file names
    fns <- list.files(path, 
                      pattern = experiment_name,
                      full.names = T)
    fns <- fns[str_detect(fns, 'Validate')]
    
    # Process each csv
    scalars <- lapply(fns, function(fn){
        scalar <- read.csv(fn, stringsAsFactors = F) %>% 
            mutate(Step = Step / step) %>% # step of each epoch
            dplyr::select(-Wall.time)
    })
    names(scalars) <- gsub(
        '.csv', "", 
        str_extract(fns, '[A-Z]{1}[A-Z|a-z]+.csv'))
    
    scalars
}

# Clean scalar csvs
curves_lr_01 <- get_curves('unet_lr_01')
curves_lr_001 <- get_curves('unet_lr_001')
curves_lr_0001 <- get_curves('unet_lr_0001')
curves_lr_00001 <- get_curves('unet_lr_00001')
curves_lr_000001 <- get_curves('unet_lr_000001')

types <- c('AA', 'IoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland')
content <- do.call(rbind, lapply(types, function(type){
    if (type == 'Built-up') {
        item <- 'Urban'
        } else{item <- type}
    list(curves_lr_01[[item]],
         curves_lr_001[[item]],
         curves_lr_0001[[item]],
         curves_lr_00001[[item]],
         curves_lr_000001[[item]]) %>% 
        reduce(left_join, by = "Step") %>% 
        `colnames<-`(c("Epoch", '0.1', '0.01', 
                       '0.001', '0.0001', '0.00001')) %>% 
        mutate(Item = type) %>% 
        pivot_longer(cols = setdiff(names(.), c("Epoch", 'Item')),
                     names_to = 'Learning rate', 
                     values_to = 'Value')
})) %>% mutate(Item = factor(Item, levels = types))

# Get final plot
curves_lr <- ggplot(content, aes(x = Epoch, y = Value)) +
    # geom_line(aes(color = `Learning rate`)) +
    geom_smooth(aes(color = `Learning rate`), span = 0.2,
                se = F, size = 0.6) +
    scale_color_brewer(palette = "Set1") +
    facet_wrap(~Item, scales = 'free_y') +
    labs(y = 'Accuracy') +
    theme_bw() +
    theme(legend.position = 'top')
ggsave(here('docs/figures/curves_lr.png'),
       curves_lr,
       width = 8, height = 5, dpi = 300)
```

### Overall results
#### Metrics
```{r}
library(glue)
# Get file names
fns <- list.files(here(
    file.path('results/scalar',
              'unet_score08_hardiness20_epoch200')), 
    full.names = T)

# Metrics
fns <- fns[str_detect(fns, 'Validate')]
metrics_last10 <- do.call(cbind, lapply(fns, function(fn){
    read.csv(fn, stringsAsFactors = F) %>% 
        dplyr::select(-c(Wall.time, Step)) %>% 
        tail(10)
}))
names(metrics_last10) <- gsub(
    '.csv', "", 
    str_extract(fns, '[A-Z|a-z]{1}[A-Z|a-z]+.csv'))

# Calculate mean and sd
items <- c('loss', 'AA', 'mIoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Urban', 'Bareland')
types <- c('Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland', 'AA')

tb <- do.call(rbind, lapply(items, function(item){
    vals <- metrics_last10 %>% pull(all_of(item))
    if (item == 'Urban') item <- 'Built-up'
    if (item == 'loss') item <- 'Loss'
    data.frame(mean = mean(vals),
               sd = sd(vals)) %>% 
        mutate(Metric = item)
}))

acc <- tb %>% filter(Metric %in% types) %>% 
    mutate(mean = round(mean * 100, 2),
           sd = round(sd * 100, 2),
           Class = factor(Metric, levels = types),
           Accuracy = glue(
               paste0('{format(round(mean, digits = 2), nsmall = 2)}',
                      '\u00B1{format(round(sd, digits = 2), nsmall = 2)} %'))) %>% 
    dplyr::select(Class, Accuracy) %>% 
    arrange(Class)
write.csv(acc, here('docs/figures/acc_last10epoch.csv'),
          row.names = F)
```

#### Scalars

```{r}
library(here)
# Get file names
fns <- list.files(here(
    file.path('results/scalar',
              'unet_score08_hardiness20_epoch200')), 
    full.names = T)

step <- 59
# Learning rate
lr <- read.csv(fns[2], stringsAsFactors = F) %>% 
    mutate(Epoch = Step / step)

# Scalars
fns <- fns[str_detect(fns, 'Validate|Train_lr')]
final_mod_scalars <- lapply(fns, function(fn){
    scalar <- read.csv(fn, stringsAsFactors = F) %>% 
        mutate(Epoch = Step / step) %>% 
        dplyr::select(-c(Wall.time, Step))
})
names(final_mod_scalars) <- gsub(
    '.csv', "", 
    str_extract(fns, '[A-Z|a-z]{1}[A-Z|a-z]+.csv'))

types <- c('Learning rate', 'Loss', 'AA', 'mIoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland')
lc <- c('Cropland', 'Forest', 
        'Grassland', 'Shrubland', 'Water', 
        'Built-up', 'Bareland', 'AA')
content <- do.call(rbind, lapply(types, function(type){
    if (type == 'Built-up') {
        item <- 'Urban'
    } else if (type == 'Loss'){
        item <- 'loss'
    } else if (type == 'Learning rate'){
        item <- 'lr'
    } else {item <- type}
    final_mod_scalars[[item]] %>% 
        mutate(Item = type)
}))

# Plot
curve_lr <- content %>% 
    filter(Item == 'Learning rate') %>% 
    mutate(Value = Value * 1000) %>% 
    ggplot(., aes(x = Epoch, y = Value)) +
    geom_line() +
    labs(y = expression(Learning ~ rate ~ (10^-3)), x = '') +
    theme_bw()
curve_loss <- content %>% 
    filter(Item == 'Loss') %>% 
    ggplot(., aes(x = Epoch, y = Value)) +
    geom_line() +
    labs(y = 'Loss', x = '') +
    theme_bw()
curve_iou <- content %>% 
    filter(Item == 'mIoU') %>% 
    ggplot(., aes(x = Epoch, y = Value)) +
    geom_line() +
    labs(y = 'mIoU', x = '') +
    theme_bw()
curves_acc <- content %>% 
    filter(Item %in% lc) %>% 
    mutate(Item = factor(Item, levels = lc)) %>% 
    ggplot(aes(x = Epoch, y = Value)) +
    geom_line() +
    labs(y = 'Accuracy') +
    facet_wrap(~Item, scales = 'free_y', 
               nrow = 2, ncol = 4) +
    theme_bw()
curves <- ggarrange(
    ggarrange(curve_lr, curve_loss, curve_iou, ncol = 3),
    curves_acc, nrow = 2, heights = c(1, 1.6))

ggsave(here('docs/figures/curves_final_mod.png'),
       curves,
       width = 8, height = 5, dpi = 300)
```

## Sensitivity analysis
### Quality weights
#### Score factor
```{r}
# Clean scalar csvs
curves_no_weight <- get_curves(
    'unet_no_weight',
    path = here('results/scalar/compare_score'))
curves_score02 <- get_curves(
    'unet_score_02',
    path = here('results/scalar/compare_score'))
curves_score08 <- get_curves(
    'unet_score_08',
    path = here('results/scalar/compare_score'))
curves_score16 <- get_curves(
    'unet_score_16',
    path = here('results/scalar/compare_score'))
curves_score32 <- get_curves(
    'unet_score_32',
    path = here('results/scalar/compare_score'))
curves_score100 <- get_curves(
    'unet_score_100',
    path = here('results/scalar/compare_score'))

types <- c('AA', 'IoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland')
content <- do.call(rbind, lapply(types, function(type){
    if (type == 'Built-up') {
        item <- 'Urban'
        } else{item <- type}
    list(curves_no_weight[[item]],
         curves_score02[[item]],
         curves_score08[[item]],
         curves_score16[[item]],
         curves_score32[[item]],
         curves_score100[[item]]) %>% 
        reduce(left_join, by = "Step") %>% 
        `colnames<-`(c("Epoch", '0', '0.2', '0.8', 
                       '1.6', '3.2', '10')) %>% 
        mutate(Item = type) %>% 
        pivot_longer(cols = setdiff(names(.), c("Epoch", 'Item')),
                     names_to = 'Weight factor', 
                     values_to = 'Value')
})) %>% mutate(Item = factor(Item, levels = types),
               `Weight factor` = factor(
                   `Weight factor`, 
                   levels = c('0', '0.2', '0.8', 
                              '1.6', '3.2', '10')))

# Get final plot
curves_score <- ggplot(content, aes(x = Epoch, y = Value)) +
    # geom_line(aes(color = `Weight factor`)) +
    geom_smooth(aes(color = `Weight factor`), span = 0.2,
                se = F, size = 0.6) +
    scale_color_manual(
        values = c('Black', 
                   RColorBrewer::brewer.pal(5, "Dark2"))) +
    # scale_color_brewer(palette = "Dark2") +
    facet_wrap(~Item, scales = 'free_y') +
    labs(y = 'Accuracy') +
    theme_bw() +
    theme(legend.position = 'top') +
    guides(color = guide_legend(nrow = 1))
ggsave(here('docs/figures/curves_score.png'),
       curves_score,
       width = 8, height = 5, dpi = 300)
```

#### Hardiness
```{r}
# Clean scalar csvs
curves_score08_nohard <- get_curves(
    'unet_score_08',
    path = here('results/scalar/compare_score'))
curves_hard2 <- get_curves(
    'unet_score08_hardiness_2',
    path = here('results/scalar/compare_score'))
curves_hard4 <- get_curves(
    'unet_score08_hardiness_4',
    path = here('results/scalar/compare_score'))
curves_hard6 <- get_curves(
    'unet_score08_hardiness_6',
    path = here('results/scalar/compare_score'))

types <- c('AA', 'IoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland')
content <- do.call(rbind, lapply(types, function(type){
    if (type == 'Built-up') {
        item <- 'Urban'
        } else{item <- type}
    list(curves_score08_nohard[[item]],
         curves_hard2[[item]],
         curves_hard4[[item]],
         curves_hard6[[item]]) %>% 
        reduce(left_join, by = "Step") %>% 
        `colnames<-`(c("Epoch", '0', '2', '4', '6')) %>% 
        mutate(Item = type) %>% 
        pivot_longer(cols = setdiff(names(.), c("Epoch", 'Item')),
                     names_to = 'Weight scale', 
                     values_to = 'Value')
})) %>% mutate(Item = factor(Item, levels = types),
               `Weight scale` = factor(
                   `Weight scale`, 
                   levels = c('0', '2', '4', '6')))

# Get final plot
curves_hard <- ggplot(content, aes(x = Epoch, y = Value)) +
    geom_smooth(aes(color = `Weight scale`), span = 0.2,
                se = F, size = 0.6) +
    scale_color_manual(
        values = c('Black', 
                   RColorBrewer::brewer.pal(3, "Dark2"))) +
    # scale_color_brewer(palette = "Dark2") +
    facet_wrap(~Item, scales = 'free_y') +
    labs(y = 'Accuracy') +
    theme_bw() +
    theme(legend.position = 'top') +
    guides(color = guide_legend(nrow = 1))
ggsave(here('docs/figures/curves_hard.png'),
       curves_hard,
       width = 8, height = 5, dpi = 300)
```

### Sampling

```{r}

```

