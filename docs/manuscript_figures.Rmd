---
title: "Manuscript figures"
author: "Lei Song"
date: "6/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

## Introduction

This is just a markdown to record the script to generate figures for the paper.

## Study area

Study area figure should include a overall view of study area in a bigger background, a zoom-in view of the study area (northern of Tanzania), the ecozones, the NICFI tiling system and the following sub-tiling system, 

```{r}
library(here)
library(sf)
library(nngeo)
library(ggplot2)
library(ggspatial)
library(RColorBrewer)
library(dplyr)
library(rnaturalearth)

# Read boundaries
tz_bry <- read_sf(here('data/geoms/tanzania.geojson'))
study_area <- read_sf(here('data/geoms/study_area.geojson')) %>% 
    st_remove_holes()
nicfi_tiles <- read_sf(here('data/geoms/tiles_nicfi_north.geojson')) %>% 
    mutate(`NICFI tile` = 1)
ecozones <- read_sf(here('data/geoms/ecozones.geojson')) %>% 
    st_intersection(study_area) %>% 
    rename(Ecozone = zone)

# The overview of study area in the whole country at the left corner
# Get the surrounding countries
sf_use_s2(FALSE)
countries <- ne_countries(
    type = 'countries', scale = 'large',
    returnclass = 'sf') %>% 
    st_intersection(
        ., st_bbox(tz_bry) %>% 
            st_as_sfc() %>% 
            st_buffer(5, joinStyle = 'MITRE') %>% 
            st_bbox(tz_bry) %>% # Get he squared one
            st_as_sfc())

# Make overview
xlim <- c(st_bbox(countries)[1] + 3, st_bbox(countries)[3] - 3)
ylim <- c(st_bbox(countries)[2] + 3, st_bbox(countries)[4] - 3)
overview <- ggplotGrob(ggplot(tz_bry) +
    geom_sf(fill = 'lightblue', color = 'grey') +
    geom_sf_text(aes(label = geounit), size = 5) +
    geom_sf(data = countries, fill = NA, color = 'grey') +
    geom_sf(data = study_area, fill = 'red', color = 'grey') +
    coord_sf(xlim = xlim, ylim = ylim) +
    theme_bw() +
    theme(axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.major = element_blank(),
          panel.background = element_rect(fill = "gray100",
                                          color = "black"),
          plot.margin = unit(rep(0, 4), "cm"),
          plot.background = element_rect(fill = "white")))

# Make the main figure
main_fg <- ggplot(ecozones) +
    geom_sf(aes(fill = Ecozone), 
            color = 'grey') +
    scale_fill_brewer(palette = 'Accent') +
    geom_sf(data = nicfi_tiles, fill = NA, 
            aes(color = "black", lty = "dotted"), 
            lwd = 0.4) +
    geom_sf(data = study_area, fill = NA, 
            aes(color = 'red', lty = 'solid')) +
    scale_color_identity(name = '',
                         breaks = c('black', 'red'),
                         labels = c('NICFI tiles', 'Study area'),
                         guide = 'legend') +
    scale_linetype_identity(name = '',
                            breaks = c('dotted', 'solid'),
                            labels = c('NICFI tiles', 'Study area'),
                            guide = 'legend') +
    annotation_custom(grob = overview, 
                      xmin = 36.64, xmax = 38.54,
                      ymin = -2.3, ymax = -0.62) +
    annotation_scale(location = 'br', text_cex = 0.8) +
    annotation_north_arrow(which_north = "true", location = 'tl',
                           height = unit(1.0, "cm"), width = unit(1.0, "cm")) +
    theme_linedraw() + 
    theme(legend.position = "bottom",
          text = element_text(size = 18),
          legend.spacing = unit(-1, "cm"),
          plot.margin = unit(c(0.3, rep(0, 3)),"cm")) +
    guides(fill = guide_legend(ncol = 1, title.position = "top", order = 1),
           color = guide_legend(nrow = 2, order = 2),
           linetype = guide_legend(nrow = 2, order = 2))

# Figure 1, combination art
# Single column figure, 1772 * 1772 at 500 dpi
ggsave(here('docs/figures/figure1_study_area.tiff'),
       main_fg, bg = "white", units = "px", 
       width = 1772, height = 2200)
```

## Satellite images

This figure will provide an example of satellite images including NICFI images with two seasons, and the harmonic regression of Sentinel-1 images.

```{r}
library(sf)
library(raster)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(tidyr)
library(stringr)
library(RStoolbox)

# Combine the Figure S2 and S3 into a single figure
## The structure is the satellite images are on the top,
## the signature curves are on the bottom.
############### PREPROCESS THE DATASET ##################
# Use tile 1227-1002, 
# this tile has a few different land cover types 
# and obvious characteristics
# so it could be a good example tile.
########################################################
tile_id <- '1227-1002'
######################## NICFI ########################
fnames_nicfi <- list.files(here('data/plts_nicfi'),
                           pattern = tile_id,
                           full.names = T)
nicfi_s1 <- stack(fnames_nicfi[1]) %>% subset(1:4)
nicfi_s2 <- stack(fnames_nicfi[2]) %>% subset(1:4)
rm(fnames_nicfi)

# Define example points
pts_example <- read_sf(here('data/north/pts_example.geojson')) %>% 
    st_cast('POINT')

# Transform points
pts_nicfi <- pts_example %>% 
    st_transform(crs = crs(nicfi_s1))

# Spectral signature of examples
# Extract values
pts_nicfi_s1 <- raster::extract(nicfi_s1, pts_nicfi) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_nicfi$type) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(`Band name` = c('Blue', 'Green', 'Red', 'NIR'),
           Band = 1:4) %>% 
    pivot_longer(cols = names(.)[1:(ncol(.) - 2)], 
                 names_to = 'Land cover type',
                 values_to = 'Reflectance') %>% 
    mutate(`Land cover type` = as.factor(`Land cover type`),
           Season = 'NICFI (season 1)')
pts_nicfi_s2 <- raster::extract(nicfi_s2, pts_nicfi) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_nicfi$type) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(`Band name` = c('Blue', 'Green', 'Red', 'NIR'),
           Band = 1:4) %>% 
    pivot_longer(cols = names(.)[1:(ncol(.) - 2)], 
                 names_to = 'Land cover type',
                 values_to = 'Reflectance') %>% 
    mutate(`Land cover type` = as.factor(`Land cover type`),
           Season = 'NICFI (season 2)')
pts_nicfi_all <- rbind(pts_nicfi_s1, pts_nicfi_s2)
rm(pts_nicfi_s1, pts_nicfi_s2)

# Replace Forest with Forest/dense tree just for the label
pts_nicfi_all <- pts_nicfi_all %>% 
    mutate(`Land cover type` = ifelse(
        `Land cover type` == "Forest",
        "Forest/dense tree", as.character(`Land cover type`)))

##### Sentinel-1 harmonic coefficient regression ######
fnames_s1 <- list.files(here('data/s1_harmonic'),
                        pattern = tile_id,
                        full.names = T)
vv_coefs <- stack(fnames_s1[str_detect(fnames_s1, 'VV')])
vh_coefs <- stack(fnames_s1[str_detect(fnames_s1, 'VH')])

# Time series and harmonic fitting of examples
# out = cos((2 * pi * n0 * t) / freq - (n % 2) * pi / 2)
# n_0 = {0,1,1,2,2}
# n = {0,1,2,3,4}
# freq = 365
# Band1: intercept
# Band2: slope
# Band3: sin(x)
# Band4: cos(x)
# Band5: sin(2x)
# Band6: cos(2x)

# Real time series
## Images
vv_ts <- stack(
    list.files(here('data/s1_timeseries_example/temp_ard_1227-1002'),
               pattern = 'VV',
               full.names = T)) 
vh_ts <- stack(
    list.files(here('data/s1_timeseries_example/temp_ard_1227-1002'),
               pattern = 'VH',
               full.names = T))

# DOY
doy <- c(0,   9,  12,  21,  33,  45,  48,  57,  69,  81,  93, 105, 117,
         129, 141, 153, 165, 177, 189, 201, 213, 225, 237, 249, 261, 273,
         285, 288, 293, 297, 300, 305, 309, 312, 317, 321, 324, 329, 333,
         336, 345, 348, 357, 360)

# Extract values
pts_vv_ts <- raster::extract(vv_ts, pts_example) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_example$type) %>% 
    mutate(date = rownames(.)) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(date = str_extract(date, '[0-9]{8}')) %>% 
    arrange(date) %>% 
    mutate(DOY = doy, polarization = 'Sentinel-1 (VV)',
           type = 'Real value')

pts_vh_ts <- raster::extract(vh_ts, pts_example) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_example$type) %>% 
    mutate(date = rownames(.)) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(date = str_extract(date, '[0-9]{8}')) %>% 
    arrange(date) %>% 
    mutate(DOY = doy, polarization = 'Sentinel-1 (VH)',
           type = 'Real value')

pts_ts <- rbind(pts_vv_ts, pts_vh_ts) %>% 
    dplyr::select(-date) %>% 
    pivot_longer(names(.)[1:7], 
                 names_to = "Land cover type", 
                 values_to = "dB")
rm(pts_vv_ts, pts_vh_ts)

# Harmonic coefficients
pts_vv <- raster::extract(vv_coefs, pts_example) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_example$type) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(`Band name` = c('Intersept', 'Slope', 
                           'Sin(x)', 'Cos(x)', 
                           'Sin(2x)', "Cos(2x)"), Band = 1:6)

pts_vv_fit <- do.call(cbind, lapply(names(pts_vv)[1:7], function(typ){
    coefs <- pts_vv %>% pull(typ)
    data.frame(val = coefs[1] + coefs[2] * doy +
                   coefs[3] * sin(2 * pi * doy /365) + 
                   coefs[4] * cos(2 * pi * doy /365) + 
                   coefs[5] * sin(4 * pi * doy /365) + 
                   coefs[6] * cos(4 * pi * doy /365))
})) %>% `names<-`(names(pts_vv)[1:7]) %>% 
    mutate(DOY = doy) %>% 
    mutate(polarization = 'Sentinel-1 (VV)',
           type = 'Harmoic regression')

pts_vh <- raster::extract(vh_coefs, pts_example) %>% 
    t() %>% data.frame() %>% 
    `names<-`(pts_example$type) %>% 
    `rownames<-`(1:nrow(.)) %>% 
    mutate(`Band name` = c('Intersept', 'Slope', 
                           'Sin(x)', 'Cos(x)', 
                           'Sin(2x)', "Cos(2x)"), Band = 1:6)

pts_vh_fit <- do.call(cbind, lapply(names(pts_vh)[1:7], function(typ){
    coefs <- pts_vh %>% pull(typ)
    data.frame(val = coefs[1] + coefs[2] * doy +
                   coefs[3] * sin(2 * pi * doy /365) + 
                   coefs[4] * cos(2 * pi * doy /365) + 
                   coefs[5] * sin(4 * pi * doy /365) + 
                   coefs[6] * cos(4 * pi * doy /365))
})) %>% `names<-`(names(pts_vh)[1:7]) %>% 
    mutate(DOY = doy) %>% 
    mutate(polarization = 'Sentinel-1 (VH)',
           type = 'Harmoic regression')

pts_fit <- rbind(pts_vv_fit, pts_vh_fit) %>% 
    pivot_longer(names(.)[1:7], 
                 names_to = "Land cover type", 
                 values_to = "dB")
rm(pts_vv_fit, pts_vh_fit)

# Replace Forest with Forest/dense tree
pts_ts <- pts_ts %>% 
    mutate(`Land cover type` = ifelse(
        `Land cover type` == "Forest",
        "Forest/dense tree", `Land cover type`))
pts_fit <- pts_fit %>% 
    mutate(`Land cover type` = ifelse(
        `Land cover type` == "Forest",
        "Forest/dense tree", `Land cover type`))

#################### Make the figure ##################
# Define colors
cols_lc <- tibble(
    cols = c('#ff7f00', '#074702', '#b2df8a',
             '#33a02c', '#3347f9', '#5a6057',
             '#fdbf6f'),
    `Land cover type` = c("Cropland", 'Forest/dense tree', 
                          "Grassland", 'Shrubland',  "Water", 
                          "Built-up", 'Bareland'),
    ids = as.factor(1:7))
# Satellite images
# Image of season 1
s1_fg <- ggRGB(nicfi_s1, r = 4, g = 3, b = 2, 
               scale = max(values(nicfi_s1)[, 2:4]), 
               stretch = 'hist') +
    geom_sf(data = pts_nicfi,
            color = 'black',
            size = 3) +
    geom_sf(data = pts_nicfi,
            aes(color = factor(id)),
            size = 2,
            show.legend = F) +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    ggtitle("NICFI (season 1)") +
    theme_void() +
    theme(plot.title = element_text(size = 12, hjust = 0.5),
          plot.margin = unit(c(-0.1, rep(-0.5, 3)),"cm"))

# Image of season 2
s2_fg <- ggRGB(nicfi_s2, r = 4, g = 3, b = 2, 
               scale = max(values(nicfi_s2)[, 2:4]), 
               stretch = 'lin') +
    geom_sf(data = pts_nicfi,
            color = 'black',
            size = 3) +
    geom_sf(data = pts_nicfi,
            aes(color = factor(id)),
            size = 2,
            show.legend = F) +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    ggtitle("NICFI (season 2)") +
    theme_void() +
    theme(plot.title = element_text(size = 12, hjust = 0.5),
          plot.margin = unit(c(-0.1, rep(-0.5, 3)),"cm"))

# Image of VV
# Slope, Cos(x), Intercept
vv_fg <- ggRGB(vv_coefs, r = 2, g = 4, b = 1, 
               scale = max(values(vv_coefs)[, c(2, 4, 1)]), 
               stretch = 'hist') +
    geom_sf(data = pts_example,
            color = 'white',
            size = 3) +
    geom_sf(data = pts_example,
            aes(color = factor(id)),
            size = 2,
            show.legend = F) +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    ggtitle("Sentinel-1 (VV)") +
    theme_void() +
    theme(plot.title = element_text(size = 12, hjust = 0.5),
          plot.margin = unit(c(-0.1, rep(-0.5, 3)),"cm"))

# Image of VH
# Slope, Cos(x), Intercept
vh_fg <- ggRGB(vh_coefs, r = 2, g = 4, b = 1, 
               scale = max(values(vh_coefs)[, c(1, 2, 4)]), 
               stretch = 'lin') +
    geom_sf(data = pts_example,
            color = 'white',
            size = 3) +
    geom_sf(data = pts_example,
            aes(color = factor(id)),
            size = 2,
            show.legend = F) +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    ggtitle("Sentinel-1 (VH)") +
    theme_void() +
    theme(plot.title = element_text(size = 12, hjust = 0.5),
          plot.margin = unit(c(-0.1, rep(-0.5, 3)),"cm"))

images <- ggarrange(
    s1_fg, s2_fg, vh_fg, vv_fg,
    ncol = 4)

## Signatures
# Burn the color table in
pts_nicfi_all <- merge(pts_nicfi_all, cols_lc[, 2:3])
pts_ts <- merge(pts_ts, cols_lc[, 2:3])
pts_fit <- merge(pts_fit, cols_lc[, 2:3])

ref_epl <- ggplot(pts_nicfi_all,
                  aes(x = Band, y = Reflectance / 1000,
                      color = ids)) +
    geom_point(size = 1.6) + geom_line(show.legend = 'line', size = 0.8) +
    ylab(bquote('Reflectance'~(10^3))) + 
    xlab("Band") +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    scale_x_discrete(limit = factor(1:4),
                     labels = unique(pts_nicfi_all$`Band name`)) +
    theme_bw() +
    facet_wrap(~ Season, nrow = 2, 
               scales = "free_y",
               strip.position = "top") +
    theme(text = element_text(size = 14),
          legend.text = element_text(size = 13))

ts_epl <- ggplot() + 
    geom_point(data = pts_ts, 
               aes(x = DOY, y = `dB`, 
                   color = factor(ids)),
               size = 1.6) +
    geom_line(data = pts_fit,
              aes(x = DOY, y = `dB`, 
                  color = factor(ids)),
              size = 0.8) +
    facet_wrap(~polarization, 
               scales = 'free_y', nrow = 2,
               strip.position = "top") +
    scale_color_manual("Land cover type",
                       values = cols_lc$cols, 
                       breaks = cols_lc$ids,
                       labels = cols_lc$`Land cover type`) +
    theme_bw() + theme(text = element_text(size = 14),
          legend.text = element_text(size = 13))

epl <- ggarrange(
    ref_epl, ts_epl,
    common.legend = TRUE, 
    legend = "bottom",
    ncol = 2)

fg <- ggarrange(images, epl, nrow = 2, heights = c(1, 2.5))

# Figure 2, combination art
# 1.5 column figure, 2756 * 2500 at 500 dpi
ggsave(here('docs/figures/figure2_satellite_images.tiff'),
       fg, bg = "white", units = "px", 
       width = 2756, height = 2500)
```

## Samples for Random forest and U-Net

This figure will provide the selected 200 tiles for RF to predict, the sub-tiling system for human checking, and the distribution of sub-tiles (chips) with score higher than 7.

```{r}
library(sf)
library(rasterVis)
library(ggnewscale)
library(cowplot)

id_selected <- '1240-995'
# Read tiles
nicfi_tiles <- read_sf(
    here('data/geoms/tiles_nicfi_north.geojson'))

# Sub-tiling
indices <- matrix(1:64, 8, 8)
indices <- indices[, ncol(indices):1]
sub_tiling <- nicfi_tiles %>% 
    filter(tile == id_selected) %>% 
    st_make_grid(n = c(8, 8)) %>% 
    st_sf() %>% 
    mutate(index = as.vector(indices))
trains_inside <- sub_tiling %>% 
    filter(index %in% (read.csv(
    here('results/north/dl_catalog_train.csv'),
    stringsAsFactors = F) %>% 
    filter(tile == id_selected) %>% 
    pull(index))) %>% 
    mutate(Usage = 'Train')
valids_inside <- sub_tiling %>% 
    filter(index %in% (read.csv(
    here('results/north/dl_catalog_valid.csv'),
    stringsAsFactors = F) %>% 
    filter(tile == id_selected) %>% 
    pull(index))) %>% 
    mutate(Usage = 'Validate')
# Labels of each sub-tile
sub_tiles <- rbind(trains_inside, valids_inside) %>% 
    arrange(index); rm(trains_inside, valids_inside)

# Sub-tiling figure
sub_tiling_fg <- ggplot(sub_tiling) + 
    geom_sf(data = sub_tiles, aes(fill = Usage),
            color = 'blue', lwd = 0.3) +
    scale_fill_manual(values = c('forestgreen', 'orangered')) +
    geom_sf(color = 'blue', fill = NA, lwd = 0.3) + 
    geom_sf_text(aes(label = index), size = 5) +
    theme_void() +
    theme(legend.position = 'bottom',
          text = element_text(size = 17),
          plot.title = element_text(hjust = -0.15, vjust = -6),
          plot.margin = unit(rep(0, 4),"cm"))

# Weak labels
labels_esb <- lapply(1:nrow(sub_tiles), function(n){
    raster(here('data/north/lc_labels_north_mask.tif')) %>% 
        crop(sub_tiles %>% slice(n))
}); names(labels_esb) <- sub_tiles$index

labels_guess <- lapply(sub_tiles$index, function(id){
    prefix <- glue('results/north/guess_labels/guess_{id_selected}')
    raster(here(glue('{prefix}_{id}.tif')))
}); names(labels_guess) <- sub_tiles$index

labels_refine <- lapply(sub_tiles$index, function(id){
    prefix <- glue('results/north/refine_labels/{id_selected}')
    raster(here(glue('{prefix}_{id}_label.tif')))
}); names(labels_refine) <- sub_tiles$index

# Plot
color_tb <- data.frame(
    id = 1:7,
    type = c("Cropland", "Forest/Dense tree", 
             "Grassland", "Shrubland", 
             "Water", 'Built-up', "Bareland"),
    color = c('#ff7f00', '#074702', '#b2df8a',
              '#33a02c', '#3347f9', '#5a6057',
              '#fdbf6f'))
plot_rst <- function(rst, bry){
    r_df <- as.data.frame(rst, xy = TRUE) %>%
        `colnames<-`(c('x', 'y', 'rst')) %>%
        mutate(rst = as.factor(rst)) %>% 
        na.omit()
    colors <- color_tb %>% filter(id %in% unique(r_df$rst))
    
    # plot
    ggplot() + 
        geom_raster(
            data = r_df, 
            aes(x = x, y = y, 
                fill = rst)) +
        scale_fill_manual(
            values = colors %>% pull(color), 
            breaks = colors %>% pull(id),
            labels = colors %>% pull(type)) +
        geom_sf(data = bry, 
                color = 'blue', fill = NA,
                lwd = 0.4) +
        theme_void() +
        theme(legend.position = 'none',
              plot.margin = unit(rep(-0.1, 4),"cm"))
}

plots_esb <- lapply(1:length(labels_esb), function(n) {
    nm <- names(labels_guess)[n]
    bry <- sub_tiles %>% filter(index == nm)
    plot_rst(labels_esb[[n]], bry)
})

plots_guess <- lapply(1:length(labels_guess), function(n) {
    nm <- names(labels_guess)[n]
    bry <- sub_tiles %>% filter(index == nm) %>% 
        st_transform(crs = crs(labels_guess[[n]]))
    plot_rst(labels_guess[[n]], bry)
})

plots_refine <- lapply(1:length(labels_refine), function(n) {
    nm <- names(labels_refine)[n]
    bry <- sub_tiles %>% filter(index == nm) %>% 
        st_transform(crs = crs(labels_refine[[n]]))
    plot_rst(labels_refine[[n]], bry)
})

# Ensemble plots
## Legend
r_df <- data.frame(x = 1:7, 
                   y = 1:7,
                   rst = as.factor(1:7))
legend_lc <- ggplot() + 
    geom_raster(
        data = r_df, 
        aes(x = x, y = y, 
            fill = rst)) +
    scale_fill_manual('Land cover',
                      values = c('#ff7f00', '#074702', '#b2df8a',
                                 '#33a02c', '#3347f9', '#5a6057',
                                 '#fdbf6f'), 
                      breaks = 1:7,
                      labels = c("Cropland", 'Forest/Dense tree', "Grassland", 
                                 'Shrubland',  "Water", "Built-up",
                                 'Bareland')) +
    theme_minimal() +
    theme(legend.position = 'right',
          text = element_text(size = 17),
          plot.margin = unit(rep(0, 4),"cm"))+
    guides(fill = guide_legend(ncol = 2))

legend_lc <- get_legend(legend_lc)
sub_tiling_fg <- ggarrange(NULL, legend_lc, NULL, sub_tiling_fg, NULL,
                           nrow = 5, heights = c(0.2, 1, 0.2, 2, 0.1))

esb_fg <- ggarrange(plotlist = plots_esb, ncol = 4,
                    labels = sub_tiles$index,
                    font.label = list(size = 16, color = "black", 
                                   face = "plain"),
                    hjust = -3, vjust = 0.25)
guess_fg <- ggarrange(plotlist = plots_guess, ncol = 4)
refine_fg <- ggarrange(plotlist = plots_refine, ncol = 4)

# Add satellite images for reference
# Satellite images
images <- lapply(sub_tiles$index, function(id){
    prefix <- glue('/Volumes/elephant/pred_stack/{id_selected}')
    rst <- stack(here(glue('{prefix}.tif')))
    bry <- sub_tiles %>% filter(index == id) %>% 
        st_transform(crs = crs(rst))
    crop(rst, bry)
}); names(images) <- sub_tiles$index

# Plot
plot_img <- function(rst, bry){
    # plot
    ggRGB(rst, r = 1, g = 2, b = 3, 
          scale = max(values(rst)),
          stretch = 'hist') +
        geom_sf(data = bry, 
                color = 'blue', fill = NA,
                lwd = 0.4) +
        theme_void() +
        theme(plot.margin = unit(rep(-0.1, 4),"cm"))
}
s1_plots <- lapply(1:length(images), function(n) {
    nm <- names(images)[n]
    bry <- sub_tiles %>% filter(index == nm) %>% 
        st_transform(crs = crs(images[[n]]))
    rst <- subset(images[[n]], c(4, 3, 2)) # 1, 2, 3
    plot_img(rst, bry)
})
s1_fg <- ggarrange(plotlist = s1_plots, ncol = 4)

s2_plots <- lapply(1:length(images), function(n) {
    nm <- names(images)[n]
    bry <- sub_tiles %>% filter(index == nm) %>% 
        st_transform(crs = crs(images[[n]]))
    rst <- subset(images[[n]], c(12, 11, 10)) # 9, 10, 11
    plot_img(rst, bry)
})
s2_fg <- ggarrange(plotlist = s2_plots, ncol = 4)

fgs <- ggarrange(esb_fg, guess_fg, refine_fg, s1_fg, s2_fg, nrow = 5,
                 labels = c('A', 'B', 'C', "S1", "S2"),
                 font.label = list(size = 16, color = "black", 
                                   face = "plain"),
                 hjust = 0.9, vjust = 6)
labels_fg <- ggarrange(NULL, fgs, sub_tiling_fg, 
                       ncol = 3, widths = c(0.1, 2, 1)) +
    theme(plot.margin = margin(0.3, 0 ,0, 0, "cm"))

# Figure 4, combination art
# 2 column figure, 3150 * 2560 at 500 dpi
ggsave(here('docs/figures/figure4_labels_example.tiff'),
       labels_fg, bg = "white", units = "px", 
       width = 3150, height = 2560)
```

## Workflow

This figure will provide an overall flowchart of methods.

## Results
### Random forest evaluation
#### Holdout validate

```{r}
load(here("data/north/final_res.rda"))
cf <- confusionMatrix(data = final_res$.predictions[[1]]$.pred_class, 
                      reference = final_res$.predictions[[1]]$landcover)
save(cf, file = here('docs/figures/rf_holdout_conf.rda'))

conf <- cf$table
# row is truth, column is predict
# match with python sklearn
conf <- matrix(as.numeric(conf), nrow = nrow(conf), ncol = ncol(conf))
conf <- t(conf)

# Calculate producer's accuracy
prac <- sapply(1:7, function(n){
  conf[n, n] / rowSums(conf)[n]
})

acc_test <- data.frame(class = 1:7,
                       producer_acc = prac)
write.csv(acc_test, here('docs/figures/rf_holdout_acc.csv'),
          row.names = F)
```

#### Independent test

```{r}
library(terra)
library(parallel)
library(ramify)
library(ranger)
library(parsnip)
library(tidymodels)
library(caret)

tiles <- read_sf(here('data/geoms/tiles_nicfi_north.geojson'))
imgs <- rast(file.path(
        "/Volumes/elephant/pred_stack",
        paste0(tiles$tile[1], ".tif")))
sample_test <- read_sf(here('data/north/plys_holdout_check.geojson')) %>% 
  st_join(tiles) %>% st_transform(crs = crs(imgs)) %>% 
  vect(); rm(imgs)

test_rf_features <- do.call(
  rbind,
  mclapply(unique(sample_test$tile),
    function(tile_nm) {
      # Get imgs
      imgs <- rast(file.path(
        "/Volumes/elephant/pred_stack",
        paste0(tile_nm, ".tif")
      ))

      # get samples
      samples_this <- sample_test[sample_test$tile == tile_nm, ]
      trainings_this <- do.call(
          rbind, 
          lapply(1:nrow(samples_this), function(n){
          sample_n <- samples_this[n, ]
          terra::extract(
              imgs, sample_n) %>%
              mutate(landcover = sample_n$landcover) %>%
              dplyr::select(-ID)
      }))
      rm(imgs, samples_this)
      gc()
      trainings_this
    }, mc.cores = 4)
)
save(test_rf_features, 
     file = file.path(here("data/north"), 
                      "test_rf_features.rda"))

load(here("data/north/guess_rf_md.rda"))
test_rf_features <- test_rf_features %>% na.omit()
pred <- predict(guess_rf_md$fit, 
                test_rf_features %>% select(-landcover))
pred <- argmax(pred$predictions)
pred <- data.frame(predict = pred,
                   test = test_rf_features$landcover)
lc_types <- data.frame(id = 1:7,
                       type = c('Cropland', 'Forest/dense tree', 'Grassland',
                                'Shrubland', 'Water', 'Built-up',
                                'Bareland'))
lc_cvt <- data.frame(type_use = c('Cropland', 'Forest/dense tree', 'Grassland',
                                'Shrubland', 'Water', 'Built-up',
                                'Bareland'),
                     type_record = c('cropland', 'forest', 'grassland',
                                'shrubland', 'water', 'built-up',
                                'bareland'))
# pred_eval <- left_join(pred, lc_types, 
#                        by = c('test' = 'type')) %>% 
#     dplyr::select(-test) %>% 
#     rename(test = id) %>% 
#     mutate(predict = as.factor(predict),
#            test = as.factor(test))

pred_eval_rf <- left_join(pred, lc_types, 
                       by = c('predict' = 'id')) %>% 
    dplyr::select(-predict) %>% 
    rename(predict = type) %>% 
    left_join(., lc_cvt, by = c('test' = 'type_record')) %>% 
    dplyr::select(-test) %>% 
    rename(test = type_use) %>% 
    mutate(predict = factor(predict, 
                            levels = c('Cropland', 'Forest/dense tree', 
                                       'Grassland', 'Shrubland', 'Water', 
                                       'Built-up','Bareland')),
           test = factor(test,
                         levels = c('Cropland', 'Forest/dense tree', 
                                    'Grassland', 'Shrubland', 'Water', 
                                    'Built-up','Bareland')))

cf_rf <- confusionMatrix(data = pred_eval_rf$predict, 
                      reference = pred_eval_rf$test)

save(pred_eval_rf, file = here('docs/figures/rf_test_eval.rda'))
save(cf_rf, file = here('docs/figures/rf_test_conf.rda'))

acc_test_rf <- cf_rf$byClass
write.csv(acc_test_rf, here('docs/figures/rf_test_acc.csv'),
          row.names = F)
```

#### Human checking
```{r}
library(sf)
library(glue)
library(here)

tile_nm <- 'catalog_sample_tiles_update.geojson'
tiles <- here(glue('results/north/{tile_nm}')) %>% 
  read_sf(); rm(tile_nm)
tiles <- tiles %>% 
  mutate(quality = glue("({score}, {hardiness})")) %>% 
  st_drop_geometry() %>% 
  mutate(quality = factor(quality))

quality_fig <- ggplot(
  tiles,
  aes(fill = factor(hardiness), x = score)) + 
  geom_bar(position = "stack") +
  scale_fill_brewer('Difficulty', palette = "Dark2") +
  xlab('Correctness') +
  ylab('Count') +
  theme_bw() +
    theme(text = element_text(size = 16))

# Figure 5, combination art
# Single figure (3.2 in in width), 1600 * 1600 at 500 dpi
ggsave(here('docs/figures/figure5_humancheck_quality.tiff'),
       quality_fig, bg = "white", units = "px", 
       width = 1600, height = 1600)
```

### Overall results
#### Metrics
```{r}
library(glue)
library(stringr)
library(caret)

# Validate
# Get file names
fns <- list.files(here(
    'results/scalar/full_runs'), 
    pattern = 'unet_k15_only_nopad_clr_200epc',
    full.names = T)

# Metrics
fns <- fns[str_detect(fns, 'Validate')]
metrics_last10 <- do.call(cbind, lapply(fns, function(fn){
    read.csv(fn, stringsAsFactors = F) %>% 
        dplyr::select(-c(Wall.time, Step)) %>% 
        tail(10)
}))
names(metrics_last10) <- gsub(
    '.csv', "", 
    str_extract(fns, '[A-Z|a-z]{1}[A-Z|a-z]+.csv'))

# Calculate mean and sd
items <- c('loss', 'AA', 'mIoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Urban', 'Bareland')
types <- c('Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland', 'AA')

tb <- do.call(rbind, lapply(items, function(item){
    vals <- metrics_last10 %>% pull(all_of(item))
    if (item == 'Urban') item <- 'Built-up'
    if (item == 'loss') item <- 'Loss'
    data.frame(mean = mean(vals),
               sd = sd(vals)) %>% 
        mutate(Metric = item)
}))

acc <- tb %>% filter(Metric %in% types) %>% 
    mutate(mean = round(mean * 100, 2),
           sd = round(sd * 100, 2),
           Class = factor(Metric, levels = types),
           Accuracy = glue(
               paste0('{format(round(mean, digits = 2), nsmall = 2)}',
                      '\u00B1{format(round(sd, digits = 2), nsmall = 2)} %'))) %>% 
    dplyr::select(Class, Accuracy) %>% 
    arrange(Class)
write.csv(acc, here('docs/figures/k15_only_acc_last10epoch.csv'),
          row.names = F)

# Test
sample_test <- read_sf(here('data/north/plys_holdout_check.geojson'))
pred <- rast(here(file.path('results/dl/prediction',
                            'unet_k15_only_clr_200epc',
                            'landcover_north.tif')))
sample_test <- vect(sample_test %>% st_transform(crs = crs(pred)))
pred_eval <- terra::extract(pred, sample_test)

sample_test <- read_sf(here('data/north/plys_holdout_check.geojson')) %>% 
    st_drop_geometry() %>% pull(landcover)
pred_eval <- do.call(rbind, lapply(1:nrow(pred_eval), function(n){
    rst_vals <- pred_eval[n, ]
    data.frame(predict = rst_vals$landcover_north,
               test = sample_test[rst_vals$ID])
}))

pred_eval <- left_join(pred_eval, lc_types, 
                       by = c('predict' = 'id')) %>% 
    dplyr::select(-predict) %>% 
    rename(predict = type) %>% 
    left_join(., lc_cvt, by = c('test' = 'type_record')) %>% 
    dplyr::select(-test) %>% 
    rename(test = type_use) %>% 
    mutate(predict = factor(predict, 
                            levels = c('Cropland', 'Forest/dense tree', 
                                       'Grassland', 'Shrubland', 'Water', 
                                       'Built-up','Bareland')),
           test = factor(test,
                         levels = c('Cropland', 'Forest/dense tree', 
                                    'Grassland', 'Shrubland', 'Water', 
                                    'Built-up','Bareland')))

cf <- confusionMatrix(data = pred_eval$predict, reference = pred_eval$test)

save(pred_eval, file = here('docs/figures/test_eval.rda'))
save(cf, file = here('docs/figures/test_conf.rda'))

acc_test <- cf$byClass
write.csv(acc_test, here('docs/figures/test_acc.csv'),
          row.names = F)
```

#### Scalars

```{r}
library(here)
library(ggplot2)
library(ggpubr)

# Get file names
fns <- list.files(here(
    'results/scalar/full_runs'), 
    pattern = 'unet_k15_only_nopad_clr_200epc', 
    full.names = T)

step <- 59
# Learning rate
lr <- read.csv(fns[2], stringsAsFactors = F) %>% 
    mutate(Epoch = Step / step)

# Scalars
fns <- fns[str_detect(fns, 'Validate|Train_lr')]
final_mod_scalars <- lapply(fns, function(fn){
    scalar <- read.csv(fn, stringsAsFactors = F) %>% 
        mutate(Epoch = Step / step) %>% 
        dplyr::select(-c(Wall.time, Step))
})
names(final_mod_scalars) <- gsub(
    '.csv', "", 
    str_extract(fns, '[A-Z|a-z]{1}[A-Z|a-z]+.csv'))

types <- c('Learning rate', 'Loss', 'Average accuracy', 
           'mIoU', 'Cropland', 'Forest/Dense tree', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland')
lc <- c('Cropland', 'Forest/Dense tree', 
        'Grassland', 'Shrubland', 'Water', 
        'Built-up', 'Bareland', 'Average accuracy')
lb <- paste0(rep("(", 8), 1:8, rep(")", 8), rep(" ", 8), lc)
content <- do.call(rbind, lapply(types, function(type){
    if (type == 'Built-up') {
        item <- 'Urban'
    } else if (type == 'Loss'){
        item <- 'loss'
    } else if (type == 'Learning rate'){
        item <- 'lr'
    } else if (type == 'Average accuracy') {
        item <- 'AA'
    } else if (type == 'Forest/Dense tree') {
        item <- 'Forest'
    } else {item <- type}
    final_mod_scalars[[item]] %>% 
        mutate(Item = type)
}))

# Plot
curve_lr <- content %>% 
    filter(Item == 'Learning rate') %>% 
    mutate(Value = Value * 1000) %>% 
    ggplot(., aes(x = Epoch, y = Value)) +
    geom_line() +
    labs(y = expression(Learning ~ rate ~ (10^-3)), x = '') +
    ggtitle('A') +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5))
curve_loss <- content %>% 
    filter(Item == 'Loss') %>% 
    ggplot(., aes(x = Epoch, y = Value)) +
    geom_line() +
    labs(y = 'Loss', x = '') +
    ggtitle('B') +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5))
curve_iou <- content %>% 
    filter(Item == 'mIoU') %>% 
    ggplot(., aes(x = Epoch, y = Value)) +
    geom_line() +
    labs(y = 'mIoU', x = '') +
    ggtitle('C') +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5))
curves_acc <- content %>% 
    filter(Item %in% lc) %>% 
    mutate(Item = factor(Item, levels = lc, labels = lb)) %>% 
    ggplot(aes(x = Epoch, y = Value)) +
    geom_line() +
    labs(y = 'Accuracy') +
    ggtitle('D') +
    facet_wrap(~Item, 
               # scales = 'free_y',
               nrow = 2, ncol = 4) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5))
curves <- ggarrange(
    ggarrange(curve_lr, curve_loss, curve_iou, ncol = 3),
    curves_acc, nrow = 2, heights = c(1, 1.7))

# Figure 6, line art
# Double figure (7 in in width), 7000 * 5000 at 1000 dpi
ggsave(here('docs/figures/figure6_training_curves.tiff'),
       curves, bg = "white", width = 7, height = 5, dpi = 1000)
```

#### Prediction examples

Provide some prediction examples of different LC types. Then provide an overall map. Could put them together.

```{r, eval=FALSE}
library(glue)

pred_path <- here(file.path('results/dl/prediction',
                            'unet_k15_only_clr_200epc',
                            'landcover_north_withwl.tif'))
score_path <- here(file.path('results/dl/prediction',
                             'unet_k15_only_clr_200epc',
                             'landcover_confidence_north_withwl.tif'))
# Partial GRASS command to get standard deviation
execGRASS('r.in.gdal', flags = c("o", "overwrite"),
          input = score_path,
          band = 1,
          output = "score")
execGRASS('r.in.gdal', flags = c("o", "overwrite"),
          input = pred_path,
          band = 1,
          output = "pred")
execGRASS("g.region", raster = "score")
execGRASS('r.stats.zonal', flags = c('overwrite'),
          base = 'pred',
          cover = 'score',
          method = 'stddev',
          output = 'class_stddev')
dst_path <- here(file.path('results/dl/prediction',
                             'unet_k15_only_clr_200epc',
                             'class_stddev.tif'))
execGRASS('r.out.gdal', flags = c("overwrite"),
          parameters = list(input = 'class_stddev', 
                            output = dst_path,
                            createopt = "COMPRESS=LZW"))

pred_path <- here(file.path('results/dl/prediction',
                            'unet_k15_only_clr_200epc',
                            'landcover_north_withwl.tif'))
score_path <- here(file.path('results/dl/prediction',
                             'unet_k15_only_clr_200epc',
                             'landcover_confidence_north_withwl.tif'))
pred <- rast(pred_path)
score <- rast(score_path)
std <- rast(dst_path)
means <- zonal(score, pred, "mean", na.rm = TRUE)
stds <- zonal(std, pred, "mean", na.rm = TRUE)

mean_std <- data.frame(means) %>% 
  left_join(data.frame(stds)) %>% 
  `colnames<-`(c('landcover', 'mean', 'std')) %>% 
  mutate(Confidence = glue(
               paste0('{format(round(mean, digits = 2), nsmall = 2)}',
                      '\u00B1{format(round(std, digits = 2), nsmall = 2)}'))) %>% 
  left_join(color_tb %>% select(id, type), by = c('landcover' = 'id')) %>% 
  rename(Landcover = type) %>% select(Landcover, Confidence)
save(mean_std, file = here('docs/figures/conf_mean_std.rda'))
```

```{r}
library(terra)
library(stars)
library(tmap)
library(ggpubr)
library(gridExtra)

load(here('docs/figures/conf_mean_std.rda'))
pred_path <- here(file.path('results/dl/prediction',
                           'unet_k15_only_clr_200epc',
                           'landcover_north_withwl.tif'))
color_tb <- data.frame(
    id = 1:8,
    type = c("Cropland", "Forest/Dense tree", 
             "Grassland", "Shrubland", 
             "Water", 'Built-up', "Bareland", 
             'Wetland'),
    color = c('#ff7f00', '#074702', '#b2df8a',
              '#33a02c', '#3347f9', '#5a6057',
              '#fdbf6f', '#0ea591'))
pred <- read_stars(pred_path)
names(pred) <- 'landcover'

# plot
# Get examples
tiles <- read_sf('data/geoms/tiles_nicfi_north.geojson')
id_selected <- c('1211-1008', '1209-997', '1221-1012', '1234-992')
tiles <- tiles %>% filter(tile %in% id_selected) %>% 
    st_transform(crs = crs(rast(pred_path))) %>% 
    mutate(id = letters[1:4])
```

#### Class areas

```{r}
# Area adjust and projection adjust area
cls_area <- terra::zonal(cell_area, pred_area, fun = "sum", na.rm = TRUE)
cls_ratio <- cls_area %>% 
    mutate(ratio = area / sum(area))

# Class proportion, class 1 - 7
cls_prop <-  data.frame(cls_area) %>% 
    rename(landcover = landcover_north, area_orig = area) %>% 
    slice(1:7) %>% 
    mutate(proportion = area_orig / sum(.$area_orig)) %>% 
    select(landcover, proportion)

# Confusion matrix
load("docs/figures/test_conf.rda")
cf_orig <- data.frame(cf$table) %>% 
    select(Prediction, Freq, Reference) %>% 
    pivot_wider(names_from = Reference, 
                values_from = Freq)
cf_orig$num <- rowSums(cf_orig[, -1], na.rm = TRUE)
cf_orig$proportion <- cls_prop$proportion
cf_ratio <- do.call(rbind, lapply(1:nrow(cf_orig), function(n){
    cf_orig[n, 2:8] / cf_orig[[n, 9]] * cf_orig[[n, 10]]
}))

## Get the adjusted proportion
cf_ratio['Pj', ] <- colSums(cf_ratio)

# Calculate the area of the whole image
whole_area <- sum(cls_area$area[1:7]) / 1000^2
class_area <- cf_ratio["Pj", ] * whole_area
class_area[, '8'] <- cls_area$area[8] / 1000^2

# Calculate the errors
cf_ratio_error <- cf_ratio[1:7, ]
cf_ratio_error$wi <- cf_orig$proportion
cf_ratio_error$n <- cf_orig$num

err_calc <- function(pi, wi, ni, whole_area) {
    # 1.96 for 95% confidence
    sqrt(sum((wi * pi - pi ^ 2) / (ni - 1))) * whole_area * 1.96
}

adjust_class_err <- unlist(lapply(1:7, function(n) {
    err_calc(cf_ratio_error[, n], 
             cf_ratio_error$wi, 
             cf_ratio_error$n, whole_area)
}))

whole_area_add_wtl <- sum(cls_area$area) / 1000^2
adjust_stats_area <- data.frame(
    area = unlist(class_area),
    confidence_interval = c(adjust_class_err, NA),
    proportion = unlist(class_area) / whole_area_add_wtl,
    prop_interval = c(adjust_class_err / whole_area_add_wtl, NA))

save(adjust_stats_area, file = 'docs/figures/adjust_modified_stats_area.rda')

# Version 2 of final map
tmap_mode("plot")
pred_final <- tm_shape(pred) +
    tm_raster("landcover", 
              #title = "Land cover types",
              title = '',
              n = 8, style = 'cat',
              labels = color_tb$type,
              palette = color_tb$color) +
    tm_shape(tiles) +
    tm_borders("black", lwd = 1.2) +
    tm_text("id", col = 'black', fontface = "bold", 
            size = 1.3, xmod = 1.1,ymod = 0.1) +
    tm_layout(frame = F,
              legend.show = FALSE,
              outer.margins = rep(0, 4),
              inner.margins = 0)
pred_final <- tmap_grob(pred_final)

r_df <- data.frame(x = 1:8, 
                   y = 1:8,
                   rst = as.factor(1:8))
legend_lc <- ggplot() + 
    geom_raster(
        data = r_df, 
        aes(x = x, y = y, 
            fill = rst)) +
    geom_polygon(data = r_df, fill = NA, color = "black", size = 1,
                 aes(x = x, y = y, lty = 'solid')) +
    scale_fill_manual('',
                      values = color_tb$color, 
                      breaks = 1:8,
                      labels = color_tb$type) +
    scale_linetype_identity(name = '',
                            breaks = c('solid'),
                            labels = c('Examples in Figure 10'),
                            guide = 'legend') +
    theme_void() +
    theme(legend.position = 'right',
          text = element_text(size = 14),
          legend.text = element_text(size = 14),
          plot.margin = unit(rep(-1, 4),"cm"))+
    guides(fill = guide_legend(ncol = 4))
legend_lc <- get_legend(legend_lc)
f1 <- ggarrange(pred_final, legend_lc, NA, 
                nrow = 3, heights = c(5, 1, 0.5))

# Barplot
cls_freq <- data.frame(area = adjust_stats_area$proportion * 100,
                       err = c(adjust_stats_area$prop_interval[1:7] * 100, 0),
                       landcover = color_tb$id) %>% 
    mutate(err_adjust_prop = glue(
        paste0('{format(round(area, digits = 1), nsmall = 1)}',
               '\u00B1{format(round(err, digits = 1), nsmall = 1)}',
               '%'))) %>% 
    arrange(-area) %>% 
    mutate(label_ypos = c(0.75, 0.75, 0.52, 2.9, 3, 3.8, 5.2, 9)* area)
cls_freq[8, 4] <- '0.6%'
cls_freq <- cls_freq %>% arrange(landcover)
cols <- color_tb$color

cls_freq <- cls_freq %>% 
    mutate(landcover = factor(landcover, 
                              levels = cls_freq %>% 
                                  arrange(desc(area)) %>% 
                                  pull(landcover)))
barplot <- ggplot(data=cls_freq, aes(x=landcover, y = area)) +
    geom_bar(stat="identity", aes(fill=as.factor(landcover))) +
    geom_errorbar(aes(ymin = area - err, ymax = area + err), 
                  width = .4, color = "black", size = 0.6,
                  position = position_dodge(.9)) +
    geom_text(aes(y=label_ypos, label=err_adjust_prop), angle = 90,
              color="black", size = 4) +
    scale_fill_manual(values = cols[as.integer(levels(cls_freq$landcover))]) +
    theme_void() +
    theme(legend.position = "none",
          plot.margin = unit(c(-0.1, -0.1, 0.1, -0.1),"cm"))

# Table
adjust_stats_area <- adjust_stats_area %>% 
    mutate(Landcover = color_tb$type) %>% 
    arrange(desc(area)) %>% 
    mutate(`Error-adjusted area` = glue(
        paste0('{format(round(area, digits = 1), nsmall = 1)}',
               '\u00B1{format(round(confidence_interval, digits = 1), nsmall = 1)}',
               ' km\u00B2'))) %>% 
    select(Landcover, `Error-adjusted area`)
adjust_stats_area[8, 2] <- '1420 km\u00B2*'

tbl_theme <- gridExtra::ttheme_default(
    core = list(fg_params=list(cex = 1, hjust = 0, x = 0.1,
                               parse = TRUE),
                bg_params = list(fill = 'gray95')),
    colhead = list(fg_params=list(cex = 1)),
    rowhead = list(fg_params=list(cex = 1)))
tbl_conf <- tableGrob(adjust_stats_area, rows = NULL, theme = tbl_theme)

pred_final_plt <- ggarrange(
    f1,
    ggarrange(NA, tbl_conf,
              barplot, NA, 
              nrow = 4,
              labels = c(NA, 'B', 'C', NA),
              font.label = list(face = "plain", size = 16),
              hjust = c(2, 6, 2, 2),
              heights = c(0.1, 1, 1, 0.1)), 
    NA,
    labels = c('A', NA, NA),
    font.label = list(face = "plain", size = 16),
    vjust = 5, hjust = -1,
    ncol = 3, widths = c(6, 2, 0.5))

# Figure 9, combination art
# 1.5 column figure , 2756 * 1700 at 500 dpi
ggsave(here('docs/figures/figure9_final_map.tiff'),
       pred_final_plt, bg = "white", 
       width = 2756, height = 1700, 
       units = "px")
```

```{r}
library(terra)
library(stars)
library(tmap)
library(ggpubr)
library(gridExtra)

pred_path <- here(file.path('results/dl/prediction',
                            'unet_k15_only_clr_200epc',
                            'landcover_north_withwl.tif'))
color_tb <- data.frame(
    id = 1:8,
    type = c("Cropland", "Forest/Dense tree", 
             "Grassland", "Shrubland", 
             "Water", 'Built-up', "Bareland", 
             'Wetland'),
    color = c('#ff7f00', '#074702', '#b2df8a',
              '#33a02c', '#3347f9', '#5a6057',
              '#fdbf6f', '#0ea591'))
pred <- read_stars(pred_path)
names(pred) <- 'landcover'

# Get examples
id_selected <- c('1211-1008', '1209-997', '1221-1012', '1234-992')

## Images
library(ggpubr)
library(RStoolbox)
library(ggplot2)

fnames_s1 <- file.path(
    "data/plts_nicfi",
    sprintf('planet_medres_normalized_analytic_2017-12_2018-05_mosaic_%s.tif', 
                               id_selected))
fnames_s2 <- file.path(
    "data/plts_nicfi",
    sprintf('planet_medres_normalized_analytic_2018-06_2018-11_mosaic_%s.tif', 
            id_selected))
fg_s1 <- lapply(fnames_s1, function(fname) {
    x <- stack(fname) %>% subset(1:3) %>% 
        raster::stretch(minq = 0.02, maxq = 0.98)
    tm <- tm_shape(x) +
        tm_rgb(r = 1, g = 2, b = 3,
               max.value = max(values(x)[, 1:3]))
    tmap_grob(tm)
})

fg_s2 <- lapply(fnames_s2, function(fname) {
    x <- stack(fname) %>% subset(1:3) %>% 
        raster::stretch(minq = 0.02, maxq = 0.98)
    tm <- tm_shape(x) +
        tm_rgb(r = 1, g = 2, b = 3,
               max.value = max(values(x)[, 1:3]))
    tmap_grob(tm)
})
s1 <- ggarrange(fg_s1[[1]], fg_s1[[2]], 
          fg_s1[[3]], fg_s1[[4]], 
          nrow = 4, ncol = 1)
s2 <- ggarrange(fg_s2[[1]], fg_s2[[2]], 
          fg_s2[[3]], fg_s2[[4]], 
          nrow = 4, ncol = 1)

# Prediction
tiles <- read_sf('data/geoms/tiles_nicfi_north.geojson')
tiles <- tiles %>% filter(tile %in% id_selected) %>% 
    st_transform(crs = crs(rast(pred_path))) %>% 
    mutate(id = 1:nrow(.))
rst_tiles <- lapply(1:nrow(tiles), function(n){
    tm <- st_crop(pred, tiles %>% slice(n)) %>% 
        tm_shape() + 
        tm_raster("landcover", 
                  n = 8, style = 'cat',
                  labels = color_tb$type,
                  palette = color_tb$color) +
        tm_layout(frame = F,
                  legend.show = F)
    tmap_grob(tm)
})
pred_ours <- ggarrange(
    rst_tiles[[2]], rst_tiles[[3]], rst_tiles[[1]], 
    rst_tiles[[4]], nrow = 4, ncol = 1)

# ESA GLC
colors <- c(color_tb$color[1:4], color_tb$color[8], 
            color_tb$color[5], color_tb$color[6:7])
labels <- c(color_tb$type[1:4], color_tb$type[8], 
            color_tb$type[5], color_tb$type[6:7])
tiles <- read_sf('data/geoms/tiles_nicfi_north.geojson')
tiles <- tiles %>% filter(tile %in% id_selected)
esa_glc <- read_stars('data/landcovers/esaglc_rcl.tif')
fgs_esa <- lapply(1:nrow(tiles), function(n){
    tm <- st_crop(esa_glc, tiles %>% slice(n)) %>% 
        tm_shape() + 
        tm_raster("esaglc_rcl.tif", 
                  n = 8, style = 'cat',
                  labels = labels,
                  palette = colors) +
        tm_layout(frame = F,
                  legend.show = F)
    tmap_grob(tm)
})
fgs_esa <- ggarrange(
    fgs_esa[[2]], fgs_esa[[3]], fgs_esa[[1]], 
    fgs_esa[[4]], nrow = 4, ncol = 1)

# FROMGLC
from_glc <- read_stars('data/landcovers/fromglc_rcl.tif')
fgs_from <- lapply(1:nrow(tiles), function(n){
    tm <- st_crop(from_glc, tiles %>% slice(n)) %>% 
        tm_shape() + 
        tm_raster("fromglc_rcl.tif", 
                  n = 8, style = 'cat',
                  labels = labels,
                  palette = colors) +
        tm_layout(frame = F,
                  legend.show = F)
    tmap_grob(tm)
})
fgs_from <- ggarrange(
    fgs_from[[2]], fgs_from[[3]], fgs_from[[1]], 
    fgs_from[[4]], nrow = 4, ncol = 1)

# Get legend
r_df <- data.frame(x = 1:8, 
                   y = 1:8,
                   rst = as.factor(1:8))
legend_lc <- ggplot() + 
    geom_raster(
        data = r_df, 
        aes(x = x, y = y, 
            fill = rst)) +
    scale_fill_manual('',
                      values = color_tb$color, 
                      breaks = 1:8,
                      labels = color_tb$type) +
    theme_void() +
    theme(legend.position = 'right',
          plot.margin = unit(rep(0, 4),"cm"),
          text = element_text(size = 14),
          legend.text = element_text(size = 14))+
    guides(fill = guide_legend(ncol = 8))
legend_lc <- get_legend(legend_lc)

ids <- ggplot() +  
    annotate("text",
             x = 0,
             y = 1,
             size = 5,
             label = "(d)") + 
    annotate("text",
             x = 0,
             y = 2,
             size = 5,
             label = "(c)") +
    annotate("text",
             x = 0,
             y = 3,
             size = 5,
             label = "(b)") +
    annotate("text",
             x = 0,
             y = 4,
             size = 5,
             label = "(a)") +
    theme_void() +
    theme(text = element_text(size = 14))

examples <- ggarrange(ggarrange(ids, NA, nrow = 2, heights = c(1, 0.2)), 
                      s1, s2, pred_ours, fgs_esa, fgs_from, 
                      ncol = 6, widths = c(0.2, rep(1, 5)),
          labels = c('', 'NICFI season 1', 'NICFI season 2', 
                     'Prediction', 'CGLS_LC100m',
                     'FROM-GLC 2017v1'),
          hjust = -0.1, vjust = 59,
          font.label = list(size = 14, color = "black", face = "plain"),
          legend.grob = legend_lc,
          legend = 'bottom')

# Figure 10, combination art
# 2 column figure (6.2 in) , 3150 * 2600 at 500 dpi
ggsave(here('docs/figures/figure10_compare_examples.tiff'),
       examples, bg = "white", 
       width = 3150, height = 2600, 
       units = "px")
```

## Sensitivity analysis
### Quality weights
#### Correctness
```{r}
library(tidyverse)
library(gridExtra)

# Define function
get_curves <- function(experiment_name,
                       step = 59,
                       path = here('results/scalar/compare_score')){
    # Get file names
    fns <- list.files(path, 
                      pattern = experiment_name,
                      full.names = T)
    fns <- fns[str_detect(fns, 'Validate')]
    
    # Process each csv
    scalars <- lapply(fns, function(fn){
        scalar <- read.csv(fn, stringsAsFactors = F) %>% 
            mutate(Step = Step / step) %>% # step of each epoch
            dplyr::select(-Wall.time)
    })
    names(scalars) <- gsub(
        '.csv', "", 
        str_extract(fns, '[A-Z]{1}[A-Z|a-z]+.csv'))
    
    scalars
}

# Clean scalar csvs
curves_no_weight <- get_curves(
    'unet_no_weight',
    path = here('results/scalar/compare_score'))
curves_k05 <- get_curves(
    'unet_k05_only',
    path = here('results/scalar/compare_score'))
curves_k15 <- get_curves(
    'unet_k15_only',
    path = here('results/scalar/compare_score'))
curves_k30 <- get_curves(
    'unet_k3_only',
    path = here('results/scalar/compare_score'))

types <- c('AA', 'mIoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland')
content <- do.call(rbind, lapply(types, function(type){
    if (type == 'Built-up') {
        item <- 'Urban'
    } else if (type == 'mIoU'){
        item <- 'IoU'
    } else {item <- type}
    list(curves_no_weight[[item]],
         curves_k05[[item]],
         curves_k15[[item]],
         curves_k30[[item]]) %>% 
        reduce(left_join, by = "Step") %>% 
        `colnames<-`(c("Epoch", '0', '0.5', '1.5', '3.0')) %>% 
        mutate(Item = type) %>% 
        pivot_longer(cols = setdiff(names(.), c("Epoch", 'Item')),
                     names_to = 'k of logistic function', 
                     values_to = 'Value')
})) %>% mutate(Item = factor(Item, levels = types),
               `k of logistic function` = factor(
                   `k of logistic function`, 
                   levels = c('0', '0.5', '1.5', '3.0')))

# Calculate mean and sd of last 10 epochs
content_plot <- content %>% 
  filter(Epoch >= 21) %>% 
  filter(Item %in% c('AA', 'mIoU')) %>% 
  group_by(Item, `k of logistic function`) %>% 
  summarise(Mean = mean(Value), 
            sd = sd(Value))

# Get final plot
curves_corr <- ggplot(
  content_plot, 
  aes(x = `k of logistic function`, y = Mean)) + 
  geom_point() +
  geom_errorbar(aes(ymin = Mean - sd, ymax = Mean + sd), width=.2,
                position = position_dodge(0.05)) +
  facet_wrap(~Item, scales = 'free_y') +
  labs(y = 'Value', x = expression(paste(k, ' of logistic function'))) +
  theme_bw()
# ggsave(here('docs/figures/sa_correctness.png'),
#        curves_corr,
#        width = 6.5, height = 2, dpi = 300)
```

#### Hardiness
```{r}
# Clean scalar csvs
curves_k15_nohard <- get_curves(
    'unet_k15_only',
    path = here('results/scalar/compare_score'))
curves_k15_h11 <- get_curves(
    'unet_k15_hard11',
    path = here('results/scalar/compare_score'))
curves_k15_h12 <- get_curves(
    'unet_k15_hard12',
    path = here('results/scalar/compare_score'))
curves_k15_h14 <- get_curves(
    'unet_k15_hard14',
    path = here('results/scalar/compare_score'))

types <- c('AA', 'mIoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland')
content <- do.call(rbind, lapply(types, function(type){
    if (type == 'Built-up') {
        item <- 'Urban'
    } else if (type == 'mIoU'){
        item <- 'IoU'
    } else {item <- type}
    list(curves_k15_nohard[[item]],
         curves_k15_h11[[item]],
         curves_k15_h12[[item]],
         curves_k15_h14[[item]]) %>% 
        reduce(left_join, by = "Step") %>% 
        `colnames<-`(c("Epoch", '1', '1.1', '1.2', '1.4')) %>% 
        mutate(Item = type) %>% 
        pivot_longer(cols = setdiff(names(.), c("Epoch", 'Item')),
                     names_to = 'Weight scale', 
                     values_to = 'Value')
})) %>% mutate(Item = factor(Item, levels = types),
               `Weight scale` = factor(
                   `Weight scale`, 
                   levels = c('1', '1.1', '1.2', '1.4')))

# Calculate mean and sd of last 10 epochs
content_plot <- content %>% 
  filter(Epoch >= 21) %>% 
  filter(Item %in% c('AA', 'mIoU')) %>% 
  group_by(Item, `Weight scale`) %>% 
  summarise(Mean = mean(Value), 
            sd = sd(Value))

# Get final plot
curves_diff <- ggplot(
  content_plot, 
  aes(x = `Weight scale`, y = Mean)) + 
  geom_point() +
  geom_errorbar(aes(ymin = Mean - sd, ymax = Mean + sd), width=.2,
                position = position_dodge(0.05)) +
  facet_wrap(~Item, scales = 'free_y') +
  labs(y = 'Value', x = expression(s[max])) +
  theme_bw()
# ggsave(here('docs/figures/sa_difficulty.png'),
#        curves_diff,
#        width = 6.5, height = 2, dpi = 300)

params_cost <- ggarrange(curves_corr, curves_diff,
                        nrow = 2)
ggsave(here('docs/figures/sa_loss_params.png'),
       params_cost,
       width = 6.5, height = 4, dpi = 300)
```

```{r}
library(tidyverse)
library(gridExtra)

# Define function
get_curves <- function(experiment_name,
                       step = 59,
                       path = here('results/scalar/compare_score')){
    # Get file names
    fns <- list.files(path, 
                      pattern = experiment_name,
                      full.names = T)
    fns <- fns[str_detect(fns, 'Validate')]
    
    # Process each csv
    scalars <- lapply(fns, function(fn){
        scalar <- read.csv(fn, stringsAsFactors = F) %>% 
            mutate(Step = Step / step) %>% # step of each epoch
            dplyr::select(-Wall.time)
    })
    names(scalars) <- gsub(
        '.csv', "", 
        str_extract(fns, '[A-Z]{1}[A-Z|a-z]+.csv'))
    
    scalars
}

# Clean scalar csvs
curves_no_weight <- get_curves(
    'unet_no_weight',
    path = here('results/scalar/compare_score'))
curves_k05 <- get_curves(
    'unet_k05_only',
    path = here('results/scalar/compare_score'))
curves_k15 <- get_curves(
    'unet_k15_only',
    path = here('results/scalar/compare_score'))
curves_k30 <- get_curves(
    'unet_k3_only',
    path = here('results/scalar/compare_score'))

types <- c('AA', 'mIoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland')
content <- do.call(rbind, lapply(types, function(type){
    if (type == 'Built-up') {
        item <- 'Urban'
    } else if (type == 'mIoU'){
        item <- 'IoU'
    } else {item <- type}
    list(curves_no_weight[[item]],
         curves_k05[[item]],
         curves_k15[[item]],
         curves_k30[[item]]) %>% 
        reduce(left_join, by = "Step") %>% 
        `colnames<-`(c("Epoch", '0', '0.5', '1.5', '3.0')) %>% 
        mutate(Item = type) %>% 
        pivot_longer(cols = setdiff(names(.), c("Epoch", 'Item')),
                     names_to = 'k of logistic function', 
                     values_to = 'Value')
})) %>% mutate(Item = factor(Item, levels = types),
               `k of logistic function` = factor(
                   `k of logistic function`, 
                   levels = c('0', '0.5', '1.5', '3.0')))

# Calculate mean and sd of last 10 epochs
content_k <- content %>% 
    filter(Epoch >= 26) %>% 
    filter(Item == 'AA') %>% 
    group_by(Item, `k of logistic function`) %>% 
    summarise(Mean = mean(Value), 
              sd = sd(Value))

# Clean scalar csvs
curves_k15_nohard <- get_curves(
    'unet_k15_only',
    path = here('results/scalar/compare_score'))
curves_k15_h11 <- get_curves(
    'unet_k15_hard11',
    path = here('results/scalar/compare_score'))
curves_k15_h12 <- get_curves(
    'unet_k15_hard12',
    path = here('results/scalar/compare_score'))
curves_k15_h14 <- get_curves(
    'unet_k15_hard14',
    path = here('results/scalar/compare_score'))

types <- c('AA', 'mIoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland')
content <- do.call(rbind, lapply(types, function(type){
    if (type == 'Built-up') {
        item <- 'Urban'
    } else if (type == 'mIoU'){
        item <- 'IoU'
    } else {item <- type}
    list(curves_k15_nohard[[item]],
         curves_k15_h11[[item]],
         curves_k15_h12[[item]],
         curves_k15_h14[[item]]) %>% 
        reduce(left_join, by = "Step") %>% 
        `colnames<-`(c("Epoch", '1', '1.1', '1.2', '1.4')) %>% 
        mutate(Item = type) %>% 
        pivot_longer(cols = setdiff(names(.), c("Epoch", 'Item')),
                     names_to = 'Weight scale', 
                     values_to = 'Value')
})) %>% mutate(Item = factor(Item, levels = types),
               `Weight scale` = factor(
                   `Weight scale`, 
                   levels = c('1', '1.1', '1.2', '1.4')))

# Calculate mean and sd of last 10 epochs
content_weight <- content %>% 
    filter(Epoch >= 26) %>% 
    filter(Item  == 'AA') %>% 
    group_by(Item, `Weight scale`) %>% 
    summarise(Mean = mean(Value), 
              sd = sd(Value))

# Get final plot
curves_corr <- ggplot(
    content_k, 
    aes(x = `k of logistic function`, y = Mean)) + 
    geom_point() +
    geom_errorbar(aes(ymin = Mean - sd, ymax = Mean + sd), width=.2,
                  position = position_dodge(0.05)) +
    labs(y = 'Average accuracy (AA)', 
         x = expression(paste(k, ' of logistic function'))) +
    theme_bw()
curves_diff <- ggplot(
    content_weight, 
    aes(x = `Weight scale`, y = Mean)) + 
    geom_point() +
    geom_errorbar(aes(ymin = Mean - sd, ymax = Mean + sd), width=.2,
                  position = position_dodge(0.05)) +
    labs(y = 'Average accuracy (AA)', x = expression(s[max])) +
    theme_bw()

params_cost <- ggarrange(curves_corr, curves_diff,
                         ncol = 2)
ggsave(here('docs/figures/sa_loss_params_v2.png'),
       params_cost,
       width = 6, height = 2, dpi = 300)

```

### Sampling

```{r}
# Clean scalar csvs
curves_full <- get_curves(
    'unet_k15_only',
    path = here('results/scalar/compare_score'))
curves_one_tile <- get_curves(
    step = 19, 
    'unet_one_tile',
    path = here('results/scalar/compare_sampling'))
curves_random_34 <- get_curves(
    step = 19,
    'unet_random_34',
    path = here('results/scalar/compare_sampling'))
curves_hori_strip_34 <- get_curves(
    step = 19,
    'unet_hori_strip_34',
    path = here('results/scalar/compare_sampling'))
curves_vert_strip_34 <- get_curves(
    step = 18,
    'vert_strip_34',
    path = here('results/scalar/compare_sampling'))
curves_two_tile <- get_curves(
    step = 39, 
    'unet_two_tile',
    path = here('results/scalar/compare_sampling'))
curves_random_67 <- get_curves(
    step = 39,
    'unet_random_67',
    path = here('results/scalar/compare_sampling'))
curves_hori_strip_67 <- get_curves(
    step = 39,
    'unet_hori_strip_67',
    path = here('results/scalar/compare_sampling'))
curves_vert_strip_67 <- get_curves(
    step = 39,
    'vert_strip_67',
    path = here('results/scalar/compare_sampling'))

types <- c('AA', 'mIoU', 'Cropland', 'Forest', 
           'Grassland', 'Shrubland', 'Water', 
           'Built-up', 'Bareland')
content <- do.call(rbind, lapply(types, function(type){
    if (type == 'Built-up') {
        item <- 'Urban'
    } else if (type == 'mIoU'){
        item <- 'IoU'
    } else {item <- type}
    list(curves_full[[item]],
         curves_one_tile[[item]],
         curves_random_34[[item]],
         curves_hori_strip_34[[item]],
         curves_vert_strip_34[[item]],
         curves_two_tile[[item]],
         curves_random_67[[item]],
         curves_hori_strip_67[[item]],
         curves_vert_strip_67[[item]]) %>% 
        reduce(left_join, by = "Step") %>% 
        `colnames<-`(c("Epoch", '3 samples/tile', '1 sample/tile', '34% (randomly)', 
                       '34% (Hori-strip)', '34% (Vert-strip)',
                       '2 samples/tile', '67% (randomly)', 
                       '67% (Hori-strip)', '67% (Vert-strip)')) %>% 
        mutate(Item = type) %>% 
        pivot_longer(cols = setdiff(names(.), c("Epoch", 'Item')),
                     names_to = 'Sampling method', 
                     values_to = 'Value')
})) %>% mutate(Item = factor(Item, levels = types),
               `Sampling method` = factor(
                   `Sampling method`, 
                   levels = c('3 samples/tile', '1 sample/tile', '34% (randomly)', 
                       '34% (Hori-strip)', '34% (Vert-strip)',
                       '2 samples/tile', '67% (randomly)', 
                       '67% (Hori-strip)', '67% (Vert-strip)')))

# Calculate mean and sd of last 10 epochs
content_plot <- content %>% 
  filter(Epoch >= 21) %>% 
  filter(`Sampling method` %in% 
           c('1 sample/tile', '34% (randomly)',
             '2 samples/tile', '67% (randomly)',
             '3 samples/tile')) %>% 
  filter(Item %in% c('AA', 'mIoU')) %>% 
  rename(`Sampling strategy` = `Sampling method`) %>% 
  group_by(Item, `Sampling strategy`) %>% 
  summarise(Mean = mean(Value), 
            sd = sd(Value))

# Get final plot
curves_sampling <- ggplot(
  content_plot, aes(x = `Sampling strategy`, y = Mean)) + 
  geom_point() +
  geom_errorbar(aes(ymin = Mean - sd, ymax = Mean + sd), 
                width =.2,
                position = position_dodge(0.05)) +
  facet_wrap(~Item, scales = 'free_y') +
  labs(y = 'Value') +
  scale_x_discrete(guide = guide_axis(angle = 45)) +
  NULL + theme_bw()
ggsave(here('docs/figures/sa_sampling.png'),
       curves_sampling,
       width = 6.5, height = 2.5, dpi = 300)
```

## Appendix
### Evaluation of LC products

Use our independent test dataset to evaluate the quality of LC products used in this study.

```{r}
library(here)
library(sf)
library(terra)
library(caret)

sample_test <- vect(here('data/north/plys_holdout_check.geojson'))
lc_types <- data.frame(id = 1:10,
                       type = c('cropland', 'forest', 'grassland',
                                'shrubland', 'wetland', 'water', 
                                "tundra", 'built-up',
                                'bareland', 'snow/ice'))
tiles <- read_sf(
    here('data/geoms/tiles_nicfi_north.geojson'),
    stringsAsFactors = F) %>% vect()

# ESA LC
esaglc <- rast(here('data/landcovers/esaglc_rcl.tif'))
esaglc_eval <- terra::extract(esaglc, sample_test, list = T, touches = T)
esaglc_eval <- do.call(rbind, lapply(1:length(esaglc_eval), function(n){
    rst_vals <- esaglc_eval[[n]][[1]]
    data.frame(product = rst_vals,
               test = sample_test[n, ]$landcover)
}))

esaglc_eval <- left_join(esaglc_eval, lc_types, 
                       by = c('test' = 'type')) %>% 
    dplyr::select(-test) %>% 
    rename(test = id) %>% 
    filter(product != 5) %>% 
    mutate(product = as.factor(product),
           test = as.factor(test))
cf <- confusionMatrix(data=esaglc_eval$product, reference = esaglc_eval$test)
save(cf, file = here('docs/figures/esaglc_test_conf.rda'))

acc_test <- cf$byClass
write.csv(acc_test, here('docs/figures/esaglc_test_acc.csv'),
          row.names = F)

# fromglc
fromglc <- rast(here('data/landcovers/fromglc_rcl.tif'))
fromglc_eval <- terra::extract(fromglc, sample_test, list = T, touches = T)
fromglc_eval <- do.call(rbind, lapply(1:length(fromglc_eval), function(n){
    rst_vals <- fromglc_eval[[n]][[1]]
    data.frame(product = rst_vals,
               test = sample_test[n, ]$landcover)
}))

fromglc_eval <- left_join(fromglc_eval, lc_types, 
                       by = c('test' = 'type')) %>% 
    dplyr::select(-test) %>% 
    rename(test = id) %>% 
    filter(product != 5) %>% 
    mutate(product = as.factor(product),
           test = as.factor(test))
cf <- confusionMatrix(data=fromglc_eval$product, reference = fromglc_eval$test)
save(cf, file = here('docs/figures/fromglc_test_conf.rda'))

acc_test <- cf$byClass
write.csv(acc_test, here('docs/figures/fromglc_test_acc.csv'),
          row.names = F)

# gfsad
gfsad <- rast(here('data/landcovers/gfsad_rcl.tif'))
gfsad_eval <- terra::extract(gfsad, sample_test, list = T, touches = T)
gfsad_eval <- do.call(rbind, lapply(1:length(gfsad_eval), function(n){
    rst_vals <- gfsad_eval[[n]][[1]]
    data.frame(product = rst_vals,
               test = sample_test[n, ]$landcover)
}))

gfsad_eval <- left_join(gfsad_eval, lc_types, 
                       by = c('test' = 'type')) %>% 
    dplyr::select(-test) %>% 
    rename(test = id) %>% 
    mutate(test = ifelse(test == 6, 6, ifelse(test == 1, 1, 0))) %>% 
    mutate(product = as.factor(product),
           test = as.factor(test))
cf <- confusionMatrix(data = gfsad_eval$product, reference = gfsad_eval$test)
save(cf, file = here('docs/figures/gfsad_test_conf.rda'))

acc_test <- cf$byClass
write.csv(acc_test, here('docs/figures/gfsad_test_acc.csv'),
          row.names = F)

# Tansis
tansis <- rast(list.files(here('data/tansis'), 
                          full.names = T, pattern = '.tif$'))
tansis <- tansis$TZ__7
tansis <- project(tansis, crs(sample_test), method = 'near')
tansis[is.na(tansis)] <- 0

tansis_eval <- terra::extract(tansis, sample_test, list = T, touches = T)
tansis_eval <- do.call(rbind, lapply(1:length(tansis_eval), function(n){
    rst_vals <- tansis_eval[[n]][[1]]
    data.frame(product = rst_vals,
               test = sample_test[n, ]$landcover)
}))

tansis_eval <- left_join(tansis_eval, lc_types, 
                         by = c('test' = 'type')) %>% 
  dplyr::select(-test) %>% 
  rename(test = id) %>% 
  mutate(test = ifelse(test == 1, 1, 0)) %>% 
  na.omit() %>% 
  mutate(product = as.factor(product),
         test = as.factor(test))
cf <- confusionMatrix(data = tansis_eval$product, 
                      reference = tansis_eval$test,
                      positive = "1")
save(cf, file = here('docs/figures/tansis_test_conf.rda'))

acc_test <- cf$byClass
write.csv(acc_test, here('docs/figures/tansis_test_acc.csv'))
```

### RF tuning

```{r}
library(here)
library(dplyr)
library(ramify)
library(ranger)
library(parsnip)
library(tidymodels)
library(vip)
library(dials)
library(ggplot2)
library(ggpubr)

load("~/Dropbox/research/hrlcm/data/north/forest_vip.rda")
# os 2017-12_2018-05, gs 2018-06_2018-11
names(forest_vip$fit$variable.importance) <- 
    c('B_S1', 'G_S1', 'R_S1', 'NIR_S1', 
      'NDVI_S1', 'EVI_S1', 'SAVI_S1', 'ARVI_S1',
      'B_S2', 'G_S2', 'R_S2', 'NIR_S2',
      'NDVI_S2', 'EVI_S2', 'SAVI_S2', 'ARVI_S2',
      'Intercept_VV', 'Slope_VV', 'Coef_sin(t)_VV',
      'Coef_cos(t)_VV', 'Coef_sin(2t)_VV', 'Coef_cos(2t)_VV',
      'Intercept_VH', 'Slope_VH', 'Coef_sin(t)_VH',
      'Coef_cos(t)_VH', 'Coef_sin(2t)_VH', 'Coef_cos(2t)_VH')
vip_figure <- vip(vi(forest_vip), 
    num_features = forest_vip$fit$num.independent.variables,
    aesthetics = list(color = "transparent", 
                      fill = "red")) +
    theme_light()

load("~/Dropbox/research/hrlcm/data/north/tune_res.rda")
tune_figure <- tune_res %>%
    collect_metrics() %>%
    filter(.metric == "accuracy") %>%
    mutate(min_n = factor(min_n)) %>%
    ggplot(aes(mtry, mean, color = min_n)) +
    geom_line() + geom_point() +
    scale_color_brewer(palette = "Dark2") +
    labs(y = "Accuracy") +
    theme_light()

params_fig <- ggarrange(vip_figure, tune_figure,
                        ncol = 2, widths = c(1, 1.2))
ggsave(here('docs/figures/rf_tuning.png'),
       params_fig,
       width = 6.5, height = 3.5, dpi = 300)
```

### Confusion matrix heatmap for RF

```{r}
cm_rf <- pred_eval_rf %>% 
    conf_mat(truth = test, 
             estimate = predict)
cm_rf_fg <- autoplot(cm_rf, type = 'heatmap', label_size = 5) +
    theme(axis.text.x = element_text(
        angle = 90, vjust = 0.5, hjust = 1,
        color = "black"),
        axis.text = element_text(color = "black"),
        text = element_text(size = 20))

# Figure 7, combination art
# Single column figure, 1772 * 1772 at 500 dpi
ggsave(here('docs/figures/sup_rf_cm_heatmap.tiff'),
       cm_rf_fg, bg = "white", units = "px", 
       width = 1772, height = 1772)
```

### Confusion matrix heatmap for U-Net
```{r}
cm <- pred_eval %>% 
    conf_mat(truth = test, 
             estimate = predict)
cm_figure <- autoplot(cm, type = 'heatmap', label_size = 5) +
    theme(axis.text.x = element_text(
        angle = 90, vjust = 0.5, hjust = 1,
        color = "black"),
        axis.text = element_text(color = "black"),
        text = element_text(size = 20))

# Figure 7, combination art
# Single column figure, 1772 * 1772 at 500 dpi
ggsave(here('docs/figures/figure7_net_cm_heatmap.tiff'),
       cm_figure, bg = "white", units = "px", 
       width = 1772, height = 1772)
```

### Land cover classification confidence
```{r}
library(stars)
library(tmap)
library(tmaptools)

pred_path <- here(file.path('results/dl/prediction',
                            'unet_k15_only_clr_200epc',
                            'landcover_confidence_north_withwl.tif'))
pred <- read_stars(pred_path)
wetlands <- read_stars(file.path('results/dl/prediction',
                                 'unet_k15_only_clr_200epc',
                                 'wetland_add.tif'))
pred[wetlands == 1] <- NA

conf_fig <- tm_shape(pred) +
    tm_raster("landcover_confidence_north_withwl.tif", 
              title = "Confidence\n(18 - 99)",
              style = 'cont',
              palette = rev(
                  get_brewer_pal('Greys', 
                                 plot = F, 
                                 contrast=c(.25, 1)))) +
    tm_layout(frame = FALSE,
              legend.text.size = 1.1,
              legend.title.size = 1.3,
              legend.title.fontface = "bold",
              legend.height = 1,
              legend.position = c("right", "top"),
              outer.margins = c(0, 0, 0, 0.01),
              inner.margins = rep(0, 4))
conf_fig <- tmap_grob(conf_fig)
conf_fig <- ggarrange(conf_fig)

# Figure 6, confidence map
# single column figure , 2756 * 1700 at 500 dpi
ggsave(here('docs/figures/figure8_conf_map.tiff'),
       conf_fig, bg = "white", 
       width = 1772, height = 1772,
       units = "px")
```

### Figures added for manuscript revision

```{r}
# Figures for reviewer1
## Harmonic fitting
t <- seq(0, 365, 1)
y <- sin(2 * pi * t / 365)
z <- cos(2 * pi * t / 365)
one_cycle <- data.frame(t = t, sin = y, cos = z)

y <- sin(4 * pi * t / 365)
z <- cos(4 * pi * t / 365)
two_cycle <- data.frame(t = t, sin = y, cos = z)

plot(t, z, type = "l", xlab = "time")

g1 <- ggplot(one_cycle) +
    geom_line(aes(x = t, y = sin), color = "black") +
    geom_line(aes(x = t, y = cos), color = "blue") +
    theme_bw() + xlab("Time") + ylab("Value") + ggtitle("One cycle (k = 1)")

g2 <- ggplot(two_cycle) +
    geom_line(aes(x = t, y = sin), color = "black") +
    geom_line(aes(x = t, y = cos), color = "blue") +
    theme_bw() + xlab("Time") + ylab("Value") + ggtitle("Two cycles (k = 2)")
g <- ggarrange(g1, g2, ncol = 2)

ggsave("/Users/pinot/downloads/harmonics.png", g,
       width = 8, height = 3)

## LC products dis-selected after pre-assessment
# Read the boundary
tiles <- vect(here('data/geoms/tiles_nicfi_north.geojson'))

# ESRI 10m land use/land cover
fnames <- list.files("/Volumes/elephant/landcovers/ESRI_LC_2018",
                     full.names = TRUE)
fnames <- fnames[grep("37M|36M", fnames)]
esri_lc <- do.call(merge, lapply(fnames, function(fname) {
    rast(fname) %>% project("epsg:4326")
})) %>% crop(tiles) %>% mask(tiles)

writeRaster(esri_lc, "/Volumes/elephant/landcovers/esri_lc_2018.tif",
            datatype = "INT1U")

# ESACCI
esacci <- rast(file.path("/Volumes/elephant/landcovers",
                         "ESACCI-LC-L4-LC10-Map-20m-P1Y-2016-v1",
                         "ESACCI-LC-L4-LC10-Map-20m-P1Y-2016-v1.0.tif")) %>% 
    crop(tiles) %>% mask(tiles)

writeRaster(esacci, "/Volumes/elephant/landcovers/esacci_2016.tif",
            datatype = "INT1U")
    
# Globland30
globeland <- rast(file.path("/Volumes/elephant/landcovers",
                         "globeland30",
                         "tanzania_2020LC030.tif")) %>% 
    crop(tiles) %>% mask(tiles)
writeRaster(globeland, "/Volumes/elephant/landcovers/globeland30.tif",
            datatype = "INT1U")

# Color table
color_tb <- data.frame(
    id_us = 1:8,
    id_orig = c(1, 2, 3, 4, 6, 7, 8, 5),
    id_esri_lc = c(5, 2, 11, 11, 1, 7, 8, 4),
    id_esacci = c(4, 1, 3, 2, 10, 8, 7, 5),
    id_globeland = c(10, 20, 30, 40, 60, 80, 90, 50),
    type = c("Cropland", "Forest/Dense tree", 
             "Grassland", "Shrubland", 
             "Water", 'Built-up', "Bareland", 
             'Wetland'),
    color = c('#ff7f00', '#074702', '#b2df8a',
              '#33a02c', '#3347f9', '#5a6057',
              '#fdbf6f', '#0ea591'))

library(tidyterra)
library(ggpubr)

esri_lc <- rast("/Volumes/elephant/landcovers/esri_lc_2018.tif")
esri_lc <- as.factor(esri_lc)
levels(esri_lc) <- data.frame(value = color_tb$id_esri_lc, 
                              Landcover = color_tb$type) %>% slice(-3) %>% 
    mutate(Landcover = ifelse(Landcover == 'Shrubland', 
                              "Rangeland", Landcover))
coltab(esri_lc) <- data.frame(values = color_tb$id_esri_lc[-3], 
                              cols = color_tb$color[-3])
esri_fg <- ggplot() +
    geom_spatraster(data = esri_lc, aes(fill = Landcover), na.rm = TRUE) +
    scale_fill_manual('',
                      values = color_tb$color[-3], 
                      na.value = "transparent",
                      na.translate = FALSE,
                      drop = TRUE) +
    theme_void()

esacci <- rast("/Volumes/elephant/landcovers/esacci_2016.tif")
esacci <- as.factor(esacci)
levels(esacci) <- data.frame(value = color_tb$id_esacci, 
                             Landcover = color_tb$type)
coltab(esacci) <- data.frame(values = color_tb$id_esacci, cols = color_tb$color)
esacci_fg <- ggplot() +
    geom_spatraster(data = esacci, aes(fill = Landcover)) +
    scale_fill_manual('',
                      values = color_tb$color, 
                      na.translate = F, drop = TRUE,
                      na.value = "transparent") +
    theme_void()

globeland <- rast("/Volumes/elephant/landcovers/globeland30.tif")
globeland <- as.factor(globeland)
levels(globeland) <- data.frame(value = color_tb$id_globeland, 
                             Landcover = color_tb$type)
coltab(globeland) <- data.frame(values = color_tb$id_globeland,
                             cols = color_tb$color)
globeland_fg <- ggplot() +
    geom_spatraster(data = globeland, aes(fill = Landcover)) +
    scale_fill_manual("",
                      values = color_tb$color, 
                      na.translate = F, drop = TRUE,
                      na.value = "transparent") +
    theme_void()

esaglc <- rast("data/landcovers/esaglc_rcl.tif") %>% 
    crop(tiles) %>% mask(tiles)
esaglc <- as.factor(esaglc)
levels(esaglc) <- data.frame(value = color_tb$id_orig, 
                                Landcover = color_tb$type)
coltab(esaglc) <- data.frame(values = color_tb$id_orig,
                                cols = color_tb$color)
esaglc_fg <- ggplot() +
    geom_spatraster(data = esaglc, aes(fill = Landcover)) +
    scale_fill_manual("",
                      values = color_tb$color, 
                      na.translate = F, drop = TRUE,
                      na.value = "transparent") +
    theme_void()

fromglc <- rast("data/landcovers/fromglc_rcl.tif") %>% 
    crop(tiles) %>% mask(tiles)
fromglc <- as.factor(fromglc)
levels(fromglc) <- data.frame(value = color_tb$id_orig, 
                              Landcover = color_tb$type)
coltab(fromglc) <- data.frame(values = color_tb$id_orig,
                              cols = color_tb$color)
fromglc_fg <- ggplot() +
    geom_spatraster(data = fromglc, aes(fill = Landcover)) +
    scale_fill_manual("",
                      values = color_tb$color, 
                      na.translate = F, drop = TRUE,
                      na.value = "transparent") +
    theme_void()

gfsad <- rast("data/landcovers/gfsad_rcl.tif") %>% 
    crop(tiles) %>% mask(tiles)
gfsad[gfsad == 6] <- NA
tansis <- rast("data/tansis/TZ_CP_preds_2018.tif") %>% 
    subset(7) %>% project("epsg:4326") %>% 
    crop(tiles) %>% mask(tiles) %>% 
    project(gfsad, method = "near")
gfsad[is.na(gfsad)] <- 0
tansis[is.na(tansis)] <- 0
tansis[tansis == 1] <- 3
crop_mask <- gfsad + tansis
crop_mask[crop_mask == 0] <- NA

crop_mask <- as.factor(crop_mask)
levels(crop_mask) <- data.frame(value = c(1, 3, 4), 
                             Landcover = c("Only GFSAD30", "Only TanSIS", "Overlap"))
coltab(crop_mask) <- data.frame(values = c(1, 3, 4),
                             cols = c("#c6e92b", "red", "#ff7f00"))

crop_fg <- ggplot() +
    geom_spatraster(data = crop_mask, na.rm = TRUE) +
    scale_fill_manual("",
                      values = c("#c6e92b", "red", "#ff7f00"), 
                      na.translate = F, drop = TRUE,
                      na.value = "transparent") +
    theme_void()


    
    
fg_prds <- ggarrange(esacci_fg, globeland_fg, esri_fg, 
                     esaglc_fg, fromglc_fg, crop_fg, 
                     labels = c("ESACCI S2 prototype LC (2016)",
                                "GLOBELAND30 (2010)",
                                "Esri Land Cover (2018)",
                                "CGLS_LC (2018)", "FROM-GLC (2017)",
                                "GFSAD30 + TanSIS"),
                     font.label = list(face = "plain", size = 12),
                     hjust = c(-0.1, -0.2, -0.2, -0.2, -0.2, -0.2),
                     ncol = 3, nrow = 2, common.legend = TRUE,
                     legend = "bottom")

ggsave(here('docs/figures/sup_figure_products.tiff'),
       fg_prds, bg = "white", 
       width = 8, height = 5.5, dpi = 300)

# Label editing
## Type 0: No need to do any edits (This does not mean the label is perfect).
## Type 1: Include classes that do not exit, e.g. no cropland in one tile.
### Human-part editing: Interpret the error, 
#### if the misclassfied class is clearly another class, 
#### then run the script tp directly change the class index.
#### if not, set 0 as the probability weight and run the script to 
#### recalculate the classes. Then double check the result.
## Type 2: The ratio of classes are improper.
## This case can be fixed by signing a smaller/higher weight to the probability
## and recalculate the land cover classes.
## For example, cropland is overestimated and shrubland is underestimated.
## Type 3: Some objects are missed/misclassfied in the tile. 
## This case cannot be fixed by the method proposed in type 2. 
## For example, some small pieces of farms are missed.
## Some road features are missed.
## Type 4: Too complex to fix by simple method. Tried the methods in type 1-3,
## leave it as it is, and give it a lower score.

# Examples
examples <- data.frame(id = c("1219-994_53", "1223-1014_10",
                              "1216-1016_54", "1228-997_40",
                              "1233-993_64"),
                       type = c("Type 0", "Type 2", "Type 1", 
                                "Type 3", "Type 4"))
guess_path <- "results/north/guess_labels"
refine_path <- "results/north/refine_labels"

fgs <- lapply(examples$type, function(tp){
    id <- examples %>% filter(type == tp) %>% pull(id)
    guess_lb <- rast(file.path(guess_path, 
                               sprintf("guess_%s.tif", id))) %>% 
        as.factor()
    levels(guess_lb) <- data.frame(value = color_tb$id_us, 
                              Landcover = color_tb$type)
    coltab(guess_lb) <- data.frame(values = color_tb$id_us, 
                                   cols = color_tb$color)
    
    refine_lb <- rast(file.path(refine_path, 
                                sprintf("%s_label.tif", id))) %>% 
        as.factor()
    levels(refine_lb) <- data.frame(value = color_tb$id_us, 
                              Landcover = color_tb$type)
    coltab(refine_lb) <- data.frame(values = color_tb$id_us, 
                                    cols = color_tb$color)
    
    lbs <- c(guess_lb, refine_lb)
    names(lbs) <- c("Gap-filled label", "Human refined label")
    
    if (tp == "Type 3") {
        draws <- read_sf("results/north/mask_vct.geojson") %>% 
            st_crop(read_sf("results/north/catalog_sample_tiles.geojson") %>% 
                        mutate(index = paste(tile, index, sep = "_")) %>% 
                        filter(index == id))
        
        ggplot() +
            geom_spatraster(data = lbs) +
            geom_sf(data = draws, fill = "transparent", color = 'black') +
            facet_wrap(~lyr, ncol = 2) +
            scale_fill_manual("",
                              values = color_tb %>% 
                                  filter(
                                      id_us %in% unique(as.vector(unique(values(lbs))))) %>% 
                                  pull(color),
                              na.translate = F, drop = TRUE,
                              na.value = "transparent") +
            theme_void() +
            theme(text = element_text(size = 14),
                  panel.spacing = unit(0, "lines"))
        
    } else {
        ggplot() +
            geom_spatraster(data = lbs) +
            facet_wrap(~lyr, ncol = 2) +
            scale_fill_manual("",
                              values = color_tb %>% 
                                  filter(
                                      id_us %in% unique(as.vector(unique(values(lbs))))) %>% 
                                  pull(color),
                              na.translate = F, drop = TRUE,
                              na.value = "transparent") +
            theme_void() +
            theme(text = element_text(size = 14),
                  panel.spacing = unit(0, "lines"))
    }
})

exp_fgs <- ggarrange(fgs[[1]], fgs[[3]], fgs[[2]], fgs[[4]],
                     labels = c("Type 0/4", "Type 1", "Type 2", "Type 3"),
                     font.label = list(size = 14, face = "plain"),
                     hjust = c(-2.1, rep(-3, 3)),
                     nrow = 2, ncol = 2,
                     common.legend = TRUE,
                     legend = "bottom")

ggsave(here('docs/figures/sup_figure_label_types.tiff'),
       exp_fgs, bg = "white", 
       width = 8, height = 5.5, dpi = 300)
```
